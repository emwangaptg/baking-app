<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒ˜ç„™å¤§å¸« Pro - V120 è¨‚å–®æç›Šåˆ†æç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icon ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            if (!window.lucide || !window.lucide.icons) return <span style={{width:size, height:size}} className="inline-block bg-gray-200 rounded"></span>;
            const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            const iconData = window.lucide.icons[kebabName] || window.lucide.icons[name.toLowerCase()];
            if (!iconData) return null;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`lucide lucide-${name} ${className}`} {...props}>
                    {iconData.map((child, index) => React.createElement(child[0], { key: index, ...child[1] }))}
                </svg>
            );
        };
        const LucideProxy = new Proxy({}, { get: (target, prop) => (props) => <Icon name={prop} {...props} /> });
        const { ChefHat, ShoppingBag, PieChart, Package, Utensils, Zap, Plus, Trash2, Save, Image: ImageIcon, ArrowLeft, Search, DollarSign, MapPin, Calculator, Calendar, AlertTriangle, LayoutDashboard, Edit3, X, RefreshCw, ClipboardList, CheckCircle, FileText, Upload, Truck, Store, AlertCircle, Tent, Coins, Filter, Clock, Flame, Percent, Link, Box, TrendingUp, TrendingDown, Activity, BarChart2, Settings, Download, UploadCloud, Cloud, CloudOff, Database, Globe, HelpCircle, Menu, Tag, Gift, EyeOff, PlusCircle, Trash, Info, RefreshCcw, Unplug, Leaf, Wrench, Users, Heart } = LucideProxy;

        // --- Utils ---
        const loadScript = (src) => new Promise((resolve, reject) => { if (document.querySelector(`script[src="${src}"]`)) return resolve(); const script = document.createElement('script'); script.src = src; script.onload = resolve; script.onerror = reject; document.head.appendChild(script); });
        const generateUniqueId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const CHART_COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#3b82f6', '#14b8a6'];
        const NUTRIENTS = [{ key: 'calories', label: 'ç†±é‡', unit: 'kcal' }, { key: 'protein', label: 'è›‹ç™½è³ª', unit: 'g' }, { key: 'fat', label: 'è„‚è‚ª', unit: 'g' }, { key: 'saturatedFat', label: 'é£½å’Œè„‚è‚ª', unit: 'g' }, { key: 'transFat', label: 'åå¼è„‚è‚ª', unit: 'g' }, { key: 'carbs', label: 'ç¢³æ°´åŒ–åˆç‰©', unit: 'g' }, { key: 'sugar', label: 'ç³–', unit: 'g' }, { key: 'sodium', label: 'éˆ‰', unit: 'mg' }];

        // --- Hook ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                } catch (e) { return defaultValue; }
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Helpers: Financial Calculations (New Feature) ---
        const calculateRecipeUnitCost = (recipe, ingredients, packaging) => {
            if (!recipe) return 0;
            let totalCost = 0;
            const safeIng = Array.isArray(ingredients) ? ingredients : [];
            const safePkg = Array.isArray(packaging) ? packaging : [];
            
            // Ingredients
            (recipe.items || []).forEach(item => {
                const ing = safeIng.find(i => i.id === item.id) || safeIng.find(i => i.name === item.name);
                if (ing) totalCost += (ing.cost || 0) * item.qty;
            });
            // Packaging
            (recipe.packagingItems || []).forEach(item => {
                const pkg = safePkg.find(p => p.id === item.id) || safePkg.find(p => p.name === item.name);
                if (pkg) totalCost += (pkg.cost || 0) * item.qty;
            });
            return totalCost / (parseFloat(recipe.yieldCount) || 1);
        };

        const calculateOrderFinancials = (order, recipes, ingredients, packaging) => {
            let materialCost = 0;
            const safeRecipes = Array.isArray(recipes) ? recipes : [];
            const safeIng = Array.isArray(ingredients) ? ingredients : [];
            const safePkg = Array.isArray(packaging) ? packaging : [];
            
            (order.items || []).forEach(item => {
                const recipe = safeRecipes.find(r => r.id === item.recipeId);
                const unitCost = calculateRecipeUnitCost(recipe, safeIng, safePkg);
                materialCost += unitCost * (item.qty || 0);
            });
            
            // Profit = Total Revenue - Material Cost
            const profit = (order.totalAmount || 0) - materialCost;
            return { cost: materialCost, profit };
        };

        // --- UI Components ---
        const Card = ({ children, className = "", onClick }) => <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-gray-100 ${className} ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}>{children}</div>;
        const Badge = ({ children, color = "gray" }) => {
            const colors = { gray: "bg-gray-100 text-gray-800", red: "bg-red-100 text-red-800", green: "bg-green-100 text-green-800", yellow: "bg-yellow-100 text-yellow-800", blue: "bg-blue-100 text-blue-800", indigo: "bg-indigo-100 text-indigo-800" };
            return <span className={`px-2 py-1 rounded-md text-xs font-medium ${colors[color]}`}>{children}</span>;
        };
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
                <div className="bg-white rounded-xl w-full max-w-7xl max-h-[95vh] flex flex-col shadow-2xl transform transition-all">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl shrink-0">
                        <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200 transition-colors"><X size={24} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar flex-1">{children}</div>
                </div>
            </div>
        );
        
        const SafeNumberInput = ({ value, onChange, className, placeholder, ...props }) => {
            const [localValue, setLocalValue] = useState(value);
            useEffect(() => { setLocalValue(value); }, [value]);
            const handleChange = (e) => {
                const val = e.target.value;
                setLocalValue(val);
                if (val === '' || !isNaN(val) || val === '-' || val.endsWith('.')) {
                    onChange(val);
                }
            };
            return <input type="text" inputMode="decimal" className={className} value={localValue} onChange={handleChange} placeholder={placeholder} {...props} />;
        };

        const SimplePieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="h-full flex items-center justify-center text-gray-400">ç„¡æ•¸æ“š</div>;
            const total = data.reduce((acc, cur) => acc + cur.value, 0); 
            if (total === 0) return <div className="h-full flex items-center justify-center text-gray-400">å°šç„¡ç‡Ÿæ”¶</div>;
            let startAngle = 0;
            return (<div className="relative w-48 h-48 mx-auto"><svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90">{data.map((slice, i) => { const angle = (slice.value / total) * 360; if (angle === 360) return <circle key={i} cx="50" cy="50" r="50" fill={slice.color} />; const x1 = 50 + 50 * Math.cos(Math.PI * startAngle / 180), y1 = 50 + 50 * Math.sin(Math.PI * startAngle / 180), x2 = 50 + 50 * Math.cos(Math.PI * (startAngle + angle) / 180), y2 = 50 + 50 * Math.sin(Math.PI * (startAngle + angle) / 180), largeArc = angle > 180 ? 1 : 0; const pathData = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`; startAngle += angle; return <path key={i} d={pathData} fill={slice.color} stroke="white" strokeWidth="1" />; })}</svg></div>);
        };

        // --- DataManager ---
        const DataManager = ({ firebaseStatus, onConnectFirebase, onDisconnectFirebase, recipes, ingredients, packaging, setRecipes }) => {
            const fileInputRef = useRef(null);
            const [configInput, setConfigInput] = useState('');
            const [isWiping, setIsWiping] = useState(false);
            const [isRelinking, setIsRelinking] = useState(false);

            const handleExport = () => { const data = { recipes: JSON.parse(localStorage.getItem('baking_recipes_v3') || '[]'), ingredients: JSON.parse(localStorage.getItem('baking_ingredients_v3') || '[]'), packaging: JSON.parse(localStorage.getItem('baking_packaging_v3') || '[]'), orders: JSON.parse(localStorage.getItem('baking_orders_v3') || '[]'), stalls: JSON.parse(localStorage.getItem('baking_stalls_v3') || '[]'), timestamp: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `baking_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
            const handleImport = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const data = JSON.parse(evt.target.result); if (confirm(`å³å°‡åŒ¯å…¥ ${data.timestamp} çš„å‚™ä»½æª”æ¡ˆã€‚\né€™å°‡è¦†è“‹ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ`)) { if(data.recipes) localStorage.setItem('baking_recipes_v3', JSON.stringify(data.recipes)); if(data.ingredients) localStorage.setItem('baking_ingredients_v3', JSON.stringify(data.ingredients)); if(data.packaging) localStorage.setItem('baking_packaging_v3', JSON.stringify(data.packaging)); if(data.orders) localStorage.setItem('baking_orders_v3', JSON.stringify(data.orders)); if(data.stalls) localStorage.setItem('baking_stalls_v3', JSON.stringify(data.stalls)); alert("è³‡æ–™åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚"); window.location.reload(); } } catch (err) { alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤"); console.error(err); } }; reader.readAsText(file); e.target.value = ''; };
            
            const handleRelinkAll = async () => {
                if(!confirm("ç¢ºå®šè¦é€²è¡Œã€Œæ™ºèƒ½é€£çµä¿®å¾©ã€å—ï¼Ÿ\nç³»çµ±å°‡æœƒå˜—è©¦ç”¨ã€Œåç¨±ã€å°‡æ‰€æœ‰é£Ÿè­œä¸­çš„é£Ÿæèˆ‡åŒ…æé‡æ–°é…å°åˆ°è³‡æ–™åº«ã€‚")) return;
                setIsRelinking(true);
                let repairedCount = 0;
                const newRecipes = (recipes||[]).map(recipe => { 
                    let changed = false;
                    const newItems = (recipe.items || []).map(item => {
                        let target = (ingredients||[]).find(i => i.id === item.id);
                        if (!target && item.name) {
                            target = (ingredients||[]).find(i => i.name.trim().toLowerCase() === item.name.trim().toLowerCase());
                            if (target) { item.id = target.id; changed = true; repairedCount++; }
                        }
                        if(target) item.name = target.name;
                        return item;
                    });
                    const newPkgItems = (recipe.packagingItems || []).map(item => {
                        let target = (packaging||[]).find(p => p.id === item.id);
                        if (!target && item.name) {
                            target = (packaging||[]).find(p => p.name.trim().toLowerCase() === item.name.trim().toLowerCase());
                            if (target) { item.id = target.id; changed = true; repairedCount++; }
                        }
                        if(target) item.name = target.name;
                        return item;
                    });
                    if (changed) return { ...recipe, items: newItems, packagingItems: newPkgItems };
                    return recipe;
                });
                setRecipes(newRecipes);
                if (firebaseStatus === 'connected') {
                    const db = firebase.firestore();
                    const batch = db.batch();
                    newRecipes.forEach(r => { const ref = db.collection('recipes').doc(r.id); batch.set(ref, r, { merge: true }); });
                    await batch.commit();
                }
                alert(`ä¿®å¾©å®Œæˆï¼å…±é‡æ–°é€£çµäº† ${repairedCount} å€‹é …ç›®ã€‚\nè«‹å›åˆ°é£Ÿè­œç®¡ç†æª¢æŸ¥ã€‚`);
                setIsRelinking(false);
            };

            const handleHardReset = async () => {
                if (!confirm("âš ï¸ è¶…ç´šè­¦å‘Š âš ï¸\n\né€™æœƒåˆªé™¤ã€Œæœ¬æ©Ÿã€å’Œã€Œé›²ç«¯ã€çš„æ‰€æœ‰è³‡æ–™ã€‚\nè³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼\n\næ‚¨ç¢ºå®šå—ï¼Ÿ")) return;
                setIsWiping(true);
                try {
                    if (firebaseStatus === 'connected') {
                        const db = firebase.firestore();
                        const collections = ['recipes', 'ingredients', 'packaging', 'orders', 'stalls'];
                        for (const col of collections) {
                            const snapshot = await db.collection(col).get();
                            if (!snapshot.empty) { const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); }
                        }
                    }
                    localStorage.clear();
                    alert("ç³»çµ±å·²å¾¹åº•é‡ç½®ï¼");
                    window.location.reload();
                } catch (e) { console.error(e); alert("é‡ç½®å¤±æ•—"); setIsWiping(false); }
            };

            const connectCloud = () => { try { const config = JSON.parse(configInput); onConnectFirebase(config); } catch (e) { alert("è¨­å®šæ ¼å¼éŒ¯èª¤"); } };
            const forceUpload = async () => { if (firebaseStatus !== 'connected') return alert("è«‹å…ˆé€£ç·šè‡³é›²ç«¯ï¼"); if (!confirm("ç¢ºå®šè¦å°‡æœ¬æ©Ÿçš„æ‰€æœ‰è³‡æ–™ä¸Šå‚³ä¸¦è¦†è“‹é›²ç«¯å—ï¼Ÿ")) return; try { const db = firebase.firestore(); const collections = ['recipes', 'ingredients', 'packaging', 'orders', 'stalls']; const btn = document.getElementById('uploadBtn'); if(btn) btn.innerText = "ä¸Šå‚³ä¸­..."; for (const col of collections) { const localData = JSON.parse(localStorage.getItem(`baking_${col}_v3`) || '[]'); const batch = db.batch(); for (const item of localData) { const ref = db.collection(col).doc(item.id); batch.set(ref, item, { merge: true }); } await batch.commit(); } alert(`åŒæ­¥æˆåŠŸï¼`); } catch (e) { console.error(e); alert("ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤"); } finally { const btn = document.getElementById('uploadBtn'); if(btn) btn.innerText = "â˜ï¸ å¼·åˆ¶ä¸Šå‚³æœ¬æ©Ÿè³‡æ–™è‡³é›²ç«¯"; } };
            
            return ( <div className="space-y-6"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><Settings className="mr-2"/> ç³»çµ±è¨­å®š</h2><Card className="p-6 border-l-4 border-l-indigo-500"><div className="flex justify-between items-start"><div><h3 className="text-xl font-bold flex items-center text-indigo-800">{firebaseStatus === 'connected' ? <Cloud className="mr-2 text-green-500"/> : <CloudOff className="mr-2 text-gray-400"/>}é›²ç«¯åŒæ­¥</h3><p className="text-sm text-gray-500 mt-1">ç‹€æ…‹: {firebaseStatus === 'connected' ? <span className="text-green-600 font-bold">å·²é€£ç·š</span> : 'æœªé€£ç·š'}</p></div>{firebaseStatus === 'connected' && (<button onClick={onDisconnectFirebase} className="px-3 py-1 border border-red-200 text-red-500 rounded hover:bg-red-50 text-sm">ä¸­æ–·é€£ç·š</button>)}</div>{firebaseStatus === 'connected' ? (<button id="uploadBtn" onClick={forceUpload} className="mt-4 w-full py-3 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 flex justify-center items-center"><UploadCloud className="mr-2"/> å¼·åˆ¶ä¸Šå‚³æœ¬æ©Ÿè³‡æ–™è‡³é›²ç«¯</button>) : (<div className="mt-4 space-y-3"><textarea className="w-full p-3 border rounded-lg font-mono text-xs bg-gray-50 h-32 focus:ring-2 focus:ring-indigo-500" placeholder='Firebase Config JSON' value={configInput} onChange={e => setConfigInput(e.target.value)} /><button onClick={connectCloud} className="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 w-full font-bold">å•Ÿç”¨é›²ç«¯åŒæ­¥</button></div>)}</Card><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><Card className="p-6"><div className="flex items-center mb-4 text-gray-600"><Download className="w-6 h-6 mr-2"/><h3 className="font-bold">å‚™ä»½è³‡æ–™ (åŒ¯å‡º)</h3></div><button onClick={handleExport} className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">ä¸‹è¼‰ .json å‚™ä»½æª”</button></Card><Card className="p-6"><div className="flex items-center mb-4 text-gray-600"><UploadCloud className="w-6 h-6 mr-2"/><h3 className="font-bold">é‚„åŸè³‡æ–™ (åŒ¯å…¥)</h3></div><input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden" /><button onClick={() => fileInputRef.current.click()} className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">é¸æ“‡æª”æ¡ˆé‚„åŸ</button></Card></div><div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mt-6"><h3 className="font-bold text-indigo-800 mb-2 flex items-center"><Wrench className="mr-2"/> é€²éšè³‡æ–™ä¿®å¾©</h3><p className="text-sm text-gray-600 mb-3">å¦‚æœæ‚¨ç™¼ç¾é£Ÿè­œä¸­çš„é£Ÿææˆ–åŒ…ææ¶ˆå¤±äº†ï¼Œè«‹æŒ‰æ­¤æŒ‰éˆ•è‡ªå‹•ä¿®å¾©ã€‚</p><button onClick={handleRelinkAll} disabled={isRelinking} className="w-full py-2 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 flex justify-center items-center">{isRelinking ? 'æ­£åœ¨æƒæä¿®å¾©ä¸­...' : 'ğŸ”„ æ™ºèƒ½ä¿®å¾©æ‰€æœ‰é€£çµ (ä¾åç¨±é…å°)'}</button></div><div className="border-t pt-6 mt-6 bg-red-50 p-4 rounded-lg border border-red-100"><h3 className="font-bold text-red-700 mb-2 flex items-center"><AlertCircle className="mr-2"/> å±éšªå€åŸŸ</h3><button onClick={handleHardReset} disabled={isWiping} className="w-full py-3 bg-red-600 text-white font-bold rounded shadow hover:bg-red-700 flex justify-center items-center">{isWiping ? 'æ­£åœ¨å¾¹åº•éŠ·æ¯€è³‡æ–™...' : 'ğŸ’€ å¾¹åº•é‡ç½®æ‰€æœ‰è³‡æ–™ (å«é›²ç«¯)'}</button></div></div> );
        };

        // --- Dashboard ---
        const Dashboard = ({ recipes, ingredients, packaging, orders, stalls }) => {
            const [viewDetail, setViewDetail] = useState(null);
            const [dateRange, setDateRange] = useState({ start: '2024-04-30', end: new Date().toISOString().split('T')[0] });
            
            // ğŸ”¥ V118: Safe Array + Filter Nulls
            const safeIngredients = Array.isArray(ingredients) ? ingredients : [];
            const safePackaging = Array.isArray(packaging) ? packaging : [];
            const safeOrders = (Array.isArray(orders) ? orders : []).filter(o => o);
            const safeStalls = (Array.isArray(stalls) ? stalls : []).filter(s => s);
            const safeRecipes = Array.isArray(recipes) ? recipes : [];
            
            const lowStockItems = [ ...safeIngredients.filter(i => !i.parentIngredientId && i.stock < (i.lowStockThreshold || 500)), ...safePackaging.filter(p => p.stock < (p.lowStockThreshold || 20)) ];
            const pendingOrders = safeOrders.filter(o => o.status === 'pending');
            const completedOrders = safeOrders.filter(o => o.status === 'completed');
            
            const orderRevenue = completedOrders.reduce((acc, order) => acc + (order.totalAmount || 0), 0);
            const stallRevenue = safeStalls.reduce((acc, stall) => acc + (stall.totalRevenue || 0), 0);
            const financialData = useMemo(() => {
                const start = new Date(dateRange.start); const end = new Date(dateRange.end); end.setHours(23, 59, 59);
                const filteredOrders = completedOrders.filter(o => { const d = new Date(o.date); return d >= start && d <= end; });
                const filteredStalls = safeStalls.filter(s => { const d = new Date(s.startDate || s.date); return d >= start && d <= end; });
                let revenue = 0, cost = 0;
                filteredOrders.forEach(order => { revenue += (order.totalAmount || 0); cost += (order.packagingFee || 0); }); 
                filteredStalls.forEach(stall => { 
                    revenue += (stall.totalRevenue || 0); 
                    cost += (stall.totalCost || 0); 
                });
                return { revenue, cost, profit: revenue - cost };
            }, [dateRange, completedOrders, safeStalls]);
            const toggleView = (view) => setViewDetail(prev => prev === view ? null : view);
            return (
                <div className="space-y-6"><div className="grid grid-cols-2 md:grid-cols-4 gap-4"><Card className={`p-4 ${viewDetail === 'pending' ? 'ring-2 ring-blue-500' : ''}`} onClick={() => toggleView('pending')}><div className="flex items-center space-x-3"><div className="p-3 bg-blue-100 rounded-full text-blue-600"><ClipboardList size={24} /></div><div><p className="text-sm text-gray-500">å¾…å‡ºè²¨</p><p className="text-2xl font-bold">{pendingOrders.length}</p></div></div></Card><Card className={`p-4 ${viewDetail === 'revenue' ? 'ring-2 ring-green-500' : ''}`} onClick={() => toggleView('revenue')}><div className="flex items-center space-x-3"><div className="p-3 bg-green-100 rounded-full text-green-600"><DollarSign size={24} /></div><div><p className="text-sm text-gray-500">ç¸½ç‡Ÿæ”¶</p><p className="text-2xl font-bold">${(orderRevenue + stallRevenue).toLocaleString()}</p></div></div></Card><Card className="p-4"><div className="flex items-center space-x-3"><div className="p-3 bg-indigo-100 rounded-full text-indigo-600"><ChefHat size={24} /></div><div><p className="text-sm text-gray-500">é£Ÿè­œæ•¸</p><p className="text-2xl font-bold">{safeRecipes.length}</p></div></div></Card><Card className={`p-4 ${viewDetail === 'lowStock' ? 'ring-2 ring-yellow-500' : ''}`} onClick={() => toggleView('lowStock')}><div className="flex items-center space-x-3"><div className="p-3 bg-yellow-100 rounded-full text-yellow-600"><AlertTriangle size={24} /></div><div><p className="text-sm text-gray-500">ç¼ºè²¨å“é …</p><p className="text-2xl font-bold text-red-600">{lowStockItems.length}</p></div></div></Card></div>{viewDetail && <div className="bg-white p-4 rounded-xl shadow border border-gray-100 animate-fade-in"><h3 className="font-bold text-lg mb-4 text-gray-700">{viewDetail === 'pending' ? 'å¾…å‡ºè²¨æ¸…å–®' : viewDetail === 'revenue' ? 'è²¡å‹™å ±è¡¨' : 'è£œè²¨æ¸…å–®'}</h3><div className="flex justify-end mb-2"><button onClick={() => setViewDetail(null)} className="text-gray-400 hover:text-gray-600"><X /></button></div>{viewDetail === 'pending' && (pendingOrders.length === 0 ? <p>ç„¡</p> : <div className="space-y-2">{pendingOrders.map(o => <div key={o.id} className="flex justify-between border-b pb-2"><span>{o.customer}</span><span className="font-bold">${o.totalAmount}</span></div>)}</div>)}{viewDetail === 'revenue' && (<div><div className="flex items-center space-x-2 mb-4"><input type="date" className="border p-1 rounded" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} />~<input type="date" className="border p-1 rounded" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} /></div><div className="grid grid-cols-3 gap-4"><div className="text-center p-2 bg-green-50 rounded"><p>æ”¶å…¥</p><p className="font-bold text-xl">${financialData.revenue.toLocaleString()}</p></div><div className="text-center p-2 bg-red-50 rounded"><p>æ”¯å‡º(ä¼°)</p><p className="font-bold text-xl">${financialData.cost.toLocaleString()}</p></div><div className="text-center p-2 bg-indigo-50 rounded"><p>æ·¨åˆ©</p><p className="font-bold text-xl">${financialData.profit.toLocaleString()}</p></div></div></div>)}{viewDetail === 'lowStock' && <div className="space-y-2">{lowStockItems.map(i => <div key={i.id} className="flex justify-between text-red-600"><span>{i.name}</span><span>å‰© {i.stock} {i.unit}</span></div>)}</div>}</div>}</div>
            );
        };

        // --- ReportManager ---
        const ReportManager = ({ recipes, orders, stalls }) => {
            const [dateRange, setDateRange] = useState({ start: '2024-04-30', end: new Date().toISOString().split('T')[0] });
            const [reportType, setReportType] = useState('product'); 
            const [sourceFilter, setSourceFilter] = useState('all'); 
            
            const reportData = useMemo(() => {
                const start = new Date(dateRange.start); const end = new Date(dateRange.end); end.setHours(23, 59, 59);
                const aggregated = [];
                const safeRecipes = Array.isArray(recipes) ? recipes : [];
                // ğŸ”¥ V118: Filter Nulls
                const safeOrders = (Array.isArray(orders) ? orders : []).filter(o => o);
                const safeStalls = (Array.isArray(stalls) ? stalls : []).filter(s => s);
                
                if (sourceFilter === 'all' || sourceFilter === 'orders') {
                    safeOrders.forEach(o => { 
                        if (o.status !== 'completed') return; 
                        const d = new Date(o.date); if (d < start || d > end) return; 
                        (o.items||[]).forEach(item => { 
                            const r = safeRecipes.find(rec => rec.id === item.recipeId); 
                            aggregated.push({ name: r ? r.name : (item.recipeName || 'æœªçŸ¥å•†å“'), category: r ? (r.category || 'æœªåˆ†é¡') : 'æœªçŸ¥', qty: item.qty, revenue: item.qty * (item.price||0), date: d, source: 'order' }); 
                        }); 
                    });
                }
                if (sourceFilter === 'all' || sourceFilter === 'stalls') {
                    safeStalls.forEach(s => { 
                        if (s.status !== 'completed') return; 
                        const d = new Date(s.startDate || s.date); if (d < start || d > end) return; 
                        (s.products||[]).forEach(p => { 
                            const r = safeRecipes.find(rec => rec.id === p.recipeId); 
                            const realRevenue = (p.soldQty * p.price) - (p.discountAmount || 0);
                            aggregated.push({ name: r ? r.name : 'æœªçŸ¥æ“ºæ”¤å•†å“', category: r ? (r.category || 'æœªåˆ†é¡') : 'æœªçŸ¥', qty: p.soldQty, revenue: realRevenue, date: d, source: 'stall' }); 
                        }); 
                    });
                }
                const grouped = {};
                aggregated.forEach(item => { 
                    let key = item.name; 
                    if (reportType === 'category') key = item.category; 
                    if (reportType === 'month') key = item.date && !isNaN(item.date) ? `${item.date.getFullYear()}-${String(item.date.getMonth()+1).padStart(2, '0')}` : 'æœªçŸ¥æ—¥æœŸ'; 
                    if (reportType === 'season') { 
                        if(item.date && !isNaN(item.date)) {
                            const m = item.date.getMonth() + 1; 
                            if (m >= 3 && m <= 5) key = 'æ˜¥å­£ (3-5æœˆ)'; else if (m >= 6 && m <= 8) key = 'å¤å­£ (6-8æœˆ)'; else if (m >= 9 && m <= 11) key = 'ç§‹å­£ (9-11æœˆ)'; else key = 'å†¬å­£ (12-2æœˆ)';
                        } else { key = 'æœªçŸ¥å­£ç¯€'; }
                    } 
                    if (!grouped[key]) grouped[key] = { label: key, qty: 0, revenue: 0 }; 
                    grouped[key].qty += item.qty; grouped[key].revenue += item.revenue; 
                });
                const result = Object.values(grouped).sort((a, b) => b.revenue - a.revenue);
                const totalRevenue = result.reduce((acc, cur) => acc + cur.revenue, 0);
                const pieData = result.slice(0, 6).map((item, idx) => ({ label: item.label, value: item.revenue, color: CHART_COLORS[idx % CHART_COLORS.length] })); 
                return { list: result, totalRevenue, pieData };
            }, [dateRange, reportType, sourceFilter, orders, stalls, recipes]);

            return (
                <div className="space-y-6"><div className="flex flex-col space-y-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><BarChart2 className="mr-2"/> éŠ·å”®å ±è¡¨ä¸­å¿ƒ</h2><div className="flex items-center space-x-1 bg-gray-50 px-2 py-1 rounded border"><input type="date" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className="bg-transparent text-sm"/><span className="text-gray-400">~</span><input type="date" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className="bg-transparent text-sm"/></div></div><div className="flex flex-wrap justify-between items-center gap-4"><div className="flex items-center bg-gray-100 rounded-lg p-1">{['product', 'category', 'month', 'season'].map(type => { const labels = { product: 'å•†å“éŠ·å”®', category: 'ç¨®é¡åˆ†æ', month: 'æœˆä»½è¶¨å‹¢', season: 'å­£ç¯€åˆ†æ' }; return (<button key={type} onClick={() => setReportType(type)} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${reportType === type ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{labels[type]}</button>) })}</div><div className="flex items-center bg-indigo-50 rounded-lg p-1 border border-indigo-100"><button onClick={() => setSourceFilter('all')} className={`px-3 py-1.5 rounded-md text-sm font-bold flex items-center transition-colors ${sourceFilter === 'all' ? 'bg-indigo-600 text-white shadow' : 'text-indigo-600 hover:bg-indigo-100'}`}>å…¨éƒ¨æ”¶ç›Š</button><button onClick={() => setSourceFilter('orders')} className={`px-3 py-1.5 rounded-md text-sm font-bold flex items-center transition-colors ${sourceFilter === 'orders' ? 'bg-indigo-600 text-white shadow' : 'text-indigo-600 hover:bg-indigo-100'}`}><Globe size={14} className="mr-1"/>ç¶²è·¯è¨‚å–®</button><button onClick={() => setSourceFilter('stalls')} className={`px-3 py-1.5 rounded-md text-sm font-bold flex items-center transition-colors ${sourceFilter === 'stalls' ? 'bg-indigo-600 text-white shadow' : 'text-indigo-600 hover:bg-indigo-100'}`}><Store size={14} className="mr-1"/>æ“ºæ”¤æ”¶ç›Š</button></div></div></div><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="md:col-span-1 space-y-4"><Card className="p-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-none"><p className="text-indigo-100 text-sm font-medium mb-1">{sourceFilter === 'all' ? 'ç¸½éŠ·å”®é¡' : sourceFilter === 'orders' ? 'ç¶²è·¯è¨‚å–®ç¸½é¡' : 'æ“ºæ”¤ç¸½æ”¶ç›Š'}</p><p className="text-3xl font-bold">${reportData.totalRevenue.toLocaleString()}</p><div className="mt-4 flex items-center text-xs text-indigo-200"><Activity size={14} className="mr-1"/> çµ±è¨ˆç­†æ•¸: {reportData.list.length} ç­†é …ç›®</div></Card><Card className="p-6"><h4 className="font-bold text-gray-700 mb-4 flex items-center"><PieChart size={18} className="mr-2"/> ç‡Ÿæ”¶ä½”æ¯” (å‰6å)</h4><div className="flex justify-center mb-4"><SimplePieChart data={reportData.pieData} /></div><div className="space-y-2">{reportData.pieData.map((d, i) => (<div key={i} className="flex justify-between text-xs items-center"><div className="flex items-center"><div className="w-2 h-2 rounded-full mr-2" style={{background: d.color}}></div><span>{d.label}</span></div><span className="font-bold text-gray-600">{Math.round((d.value/reportData.totalRevenue)*100)}%</span></div>))}</div></Card></div><div className="md:col-span-2"><Card className="overflow-hidden"><div className="p-4 border-b bg-gray-50 flex justify-between items-center"><h4 className="font-bold text-gray-700">è©³ç´°éŠ·å”®æ•¸æ“š</h4></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-white text-gray-500 border-b"><tr><th className="p-3 w-16 text-center">æ’å</th><th className="p-3">é …ç›®åç¨±</th><th className="p-3 text-right">éŠ·å”®æ•¸é‡</th><th className="p-3 text-right">éŠ·å”®é‡‘é¡</th><th className="p-3 w-24">ä½”æ¯”</th></tr></thead><tbody className="divide-y">{reportData.list.length === 0 ? (<tr><td colSpan="5" className="p-8 text-center text-gray-400">æ­¤å€é–“ç„¡éŠ·å”®è³‡æ–™</td></tr>) : reportData.list.map((item, idx) => (<tr key={idx} className="hover:bg-gray-50"><td className="p-3 text-center font-bold text-gray-400">#{idx+1}</td><td className="p-3 font-medium text-gray-800">{item.label}</td><td className="p-3 text-right text-gray-600">{item.qty}</td><td className="p-3 text-right font-bold text-indigo-600">${item.revenue.toLocaleString()}</td><td className="p-3"><div className="flex items-center"><div className="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden mr-2"><div className="h-full bg-indigo-500" style={{width: `${(item.revenue/reportData.totalRevenue)*100}%`}}></div></div></div></td></tr>))}</tbody></table></div></Card></div></div></div>
            );
        };

        // --- RecipeManager ---
        const RecipeManager = ({ recipes, ingredients, packaging, onSave, onDelete, onClearAll }) => {
            const [editingId, setEditingId] = useState(null);
            const [recipeForm, setRecipeForm] = useState({ name: '', category: '', sellingPrice: 0, items: [], packagingItems: [], yieldCount: 1, note: '', markupPercent: 0, extraFee: 50 });
            const categories = ['è›‹ç³•', 'éºµåŒ…', 'é¤…ä¹¾', 'ç”œé»', 'å…¶ä»–'];
            const fileInputRef = useRef(null);

            const startEdit = (recipe) => {
                setEditingId(recipe.id);
                let form = JSON.parse(JSON.stringify(recipe));
                if (form.markupPercent === undefined) form.markupPercent = 0;
                if (form.extraFee === undefined) form.extraFee = 50;
                // å˜—è©¦ä¿®å¾©é€£çµ (å¦‚æœåç¨±å°å¾—ä¸Š)
                form.items = form.items.map(item => {
                    let exists = (ingredients||[]).find(i => i.id === item.id);
                    if (!exists && item.name) {
                        const recovered = (ingredients||[]).find(i => i.name.trim().toLowerCase() === item.name.trim().toLowerCase());
                        if (recovered) { exists = recovered; item.id = recovered.id; }
                    } else if (exists) { item.name = exists.name; }
                    return item;
                });
                form.packagingItems = (form.packagingItems||[]).map(item => {
                    let exists = (packaging||[]).find(p => p.id === item.id);
                    if (!exists && item.name) {
                        const recovered = (packaging||[]).find(p => p.name.trim().toLowerCase() === item.name.trim().toLowerCase());
                        if (recovered) { exists = recovered; item.id = recovered.id; }
                    } else if (exists) { item.name = exists.name; }
                    return item;
                });
                setRecipeForm(form);
            };

            const startNew = () => {
                setEditingId('new');
                setRecipeForm({ name: '', category: 'è›‹ç³•', sellingPrice: 0, items: [], packagingItems: [], yieldCount: 1, note: '', markupPercent: 0, extraFee: 50 });
            };

            const checkRecipeHealth = (recipe) => {
                let hasError = false;
                if (recipe.items && recipe.items.length > 0) {
                    const missingIng = recipe.items.some(i => !(ingredients || []).find(ing => ing.id === i.id));
                    if (missingIng) hasError = true;
                }
                if (recipe.packagingItems && recipe.packagingItems.length > 0) {
                    const missingPkg = recipe.packagingItems.some(p => !(packaging || []).find(pkg => pkg.id === p.id));
                    if (missingPkg) hasError = true;
                }
                return hasError;
            };

            const calculateCost = (form) => {
                let totalCost = 0;
                const safeIngredients = Array.isArray(ingredients) ? ingredients : [];
                const safePackaging = Array.isArray(packaging) ? packaging : [];
                (form.items || []).forEach(item => {
                    const ing = safeIngredients.find(i => i.id === item.id) || safeIngredients.find(i => i.name === item.name);
                    if (ing) { const costPerUnit = ing.cost || 0; totalCost += costPerUnit * item.qty; }
                });
                (form.packagingItems || []).forEach(item => {
                    const pkg = safePackaging.find(p => p.id === item.id) || safePackaging.find(p => p.name === item.name);
                    if (pkg) { const costPerUnit = pkg.cost || 0; totalCost += costPerUnit * item.qty; }
                });
                return totalCost / (parseFloat(form.yieldCount) || 1);
            };

            const calculateNutrition = (form) => {
                const total = NUTRIENTS.reduce((acc, curr) => ({...acc, [curr.key]: 0}), {});
                let hasData = false;
                const safeIngredients = Array.isArray(ingredients) ? ingredients : [];
                (form.items || []).forEach(item => {
                    const ing = safeIngredients.find(i => i.id === item.id) || safeIngredients.find(i => i.name === item.name);
                    if (ing && ing.nutrition) {
                        hasData = true;
                        const factor = item.qty / 100;
                        NUTRIENTS.forEach(nut => { total[nut.key] += (ing.nutrition[nut.key] || 0) * factor; });
                    }
                });
                const yieldCount = parseFloat(form.yieldCount) || 1;
                const perServing = NUTRIENTS.reduce((acc, curr) => ({ ...acc, [curr.key]: total[curr.key] / yieldCount }), {});
                return { total, perServing, hasData };
            };

            const handleImportClick = () => fileInputRef.current.click();
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = window.XLSX.read(data, { type: 'array' });
                    const jsonData = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    processExcelData(jsonData);
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
            };

            const processExcelData = (rows) => {
                let successCount = 0;
                let failLog = [];
                const safeIngredients = Array.isArray(ingredients) ? ingredients : [];
                const safePackaging = Array.isArray(packaging) ? packaging : [];
                
                rows.forEach((row, idx) => {
                    const name = row['åç¨±'] || row['é£Ÿè­œåç¨±'];
                    if (!name) return;
                    
                    const newItem = { 
                        id: generateUniqueId(), 
                        name: name, 
                        category: row['åˆ†é¡'] || 'å…¶ä»–', 
                        sellingPrice: parseFloat(row['å”®åƒ¹'] || 0), 
                        yieldCount: parseFloat(row['ç”¢å‡ºä»½æ•¸'] || 1), 
                        note: row['å‚™è¨»'] || '', 
                        markupPercent: parseFloat(row['æˆæœ¬æ¨¡å¼'] || 0),
                        extraFee: 50,
                        items: [], 
                        packagingItems: [] 
                    };

                    const ingStr = row['é£Ÿæåˆ—è¡¨'] || row['é£Ÿæ'];
                    if (ingStr) {
                        const parts = ingStr.toString().split(/[,ï¼Œ]/);
                        parts.forEach(p => {
                            const [iName, iQty] = p.split(/[:ï¼š]/);
                            if (iName && iQty) {
                                const cleanName = iName.trim();
                                const targetIng = safeIngredients.find(i => i.name.trim().toLowerCase() === cleanName.toLowerCase());
                                if (!targetIng) failLog.push(`é£Ÿè­œ[${name}]: æ‰¾ä¸åˆ°é£Ÿæ "${cleanName}"`);
                                newItem.items.push({ id: targetIng ? targetIng.id : generateUniqueId(), name: cleanName, qty: parseFloat(iQty) });
                            }
                        });
                    }
                    const pkgStr = row['åŒ…æåˆ—è¡¨'] || row['åŒ…æ'];
                    if (pkgStr) {
                        const parts = pkgStr.toString().split(/[,ï¼Œ]/);
                        parts.forEach(p => {
                            const [pName, pQty] = p.split(/[:ï¼š]/);
                            if (pName && pQty) {
                                const cleanName = pName.trim();
                                const targetPkg = safePackaging.find(pkg => pkg.name.trim().toLowerCase() === cleanName.toLowerCase());
                                if (!targetPkg) failLog.push(`é£Ÿè­œ[${name}]: æ‰¾ä¸åˆ°åŒ…æ "${cleanName}"`);
                                newItem.packagingItems.push({ id: targetPkg ? targetPkg.id : generateUniqueId(), name: cleanName, qty: parseFloat(pQty) });
                            }
                        });
                    }
                    onSave(newItem);
                    successCount++;
                });
                let msg = `æˆåŠŸåŒ¯å…¥ ${successCount} ç­†é£Ÿè­œï¼(å·²å¥—ç”¨æˆæœ¬æ¨¡å¼è¨­å®š)`;
                if (failLog.length > 0) { msg += `\n\nâš ï¸ æ³¨æ„ï¼šæœ‰ ${failLog.length} å€‹é …ç›®é€£çµå¤±æ•— (è«‹æª¢æŸ¥åç¨±æ˜¯å¦å®Œå…¨ä¸€è‡´)ï¼š\n` + failLog.slice(0, 5).join('\n') + (failLog.length > 5 ? '\n...' : ''); }
                alert(msg);
            };

            const save = () => { if (!recipeForm.name) return alert('è«‹è¼¸å…¥åç¨±'); onSave(recipeForm, editingId === 'new' ? null : editingId); setEditingId(null); };

            const confirmClearAll = () => {
                if(confirm("ç¢ºå®šè¦ã€æ¸…ç©ºã€‘æ‰€æœ‰é£Ÿè­œå—ï¼Ÿ\n\né€™é€šå¸¸ç”¨æ–¼ï¼šæƒ³è¦é‡æ–°åŒ¯å…¥ä¸€ä»½å…¨æ–°çš„ Excel é£Ÿè­œè¡¨ã€‚\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
                    onClearAll();
                }
            };

            if (editingId) {
                const currentCost = calculateCost(recipeForm);
                const profit = (parseFloat(recipeForm.sellingPrice) || 0) - currentCost;
                const margin = (parseFloat(recipeForm.sellingPrice) || 0) > 0 ? (profit / recipeForm.sellingPrice) * 100 : 0;
                const nutritionData = calculateNutrition(recipeForm);

                return (
                    <Modal title={editingId === 'new' ? 'æ–°å¢é£Ÿè­œ' : 'ç·¨è¼¯é£Ÿè­œ'} onClose={() => setEditingId(null)}>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <div><label className="text-xs text-gray-500">é£Ÿè­œåç¨±</label><input className="w-full border p-2 rounded" value={recipeForm.name} onChange={e => setRecipeForm({ ...recipeForm, name: e.target.value })} /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="text-xs text-gray-500">åˆ†é¡</label><select className="w-full border p-2 rounded" value={recipeForm.category} onChange={e => setRecipeForm({ ...recipeForm, category: e.target.value })}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                    <div><label className="text-xs text-gray-500">è²©å”®åƒ¹æ ¼ ($)</label><SafeNumberInput className="w-full border p-2 rounded font-bold text-indigo-700" value={recipeForm.sellingPrice} onChange={v => setRecipeForm({ ...recipeForm, sellingPrice: v })} /></div>
                                </div>
                                <div><label className="text-xs text-gray-500">é è¨ˆç”¢å‡ºæ•¸é‡ (ä»½)</label><SafeNumberInput className="w-full border p-2 rounded" value={recipeForm.yieldCount} onChange={v => setRecipeForm({ ...recipeForm, yieldCount: v })} /></div>
                                
                                <div className="bg-gray-50 p-4 rounded-lg space-y-3 border border-gray-200">
                                    <div className="flex justify-between text-sm items-center"><span className="text-gray-500">å–®ä»½æˆæœ¬:</span><span className="font-bold text-red-600 text-lg">${currentCost.toFixed(1)}</span></div>
                                    <div className="flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-100 flex-wrap gap-2">
                                        <div className="flex items-center space-x-1"><span className="text-sm text-blue-700 font-bold">æˆæœ¬ x (1 +</span><input type="number" className="w-14 border border-blue-300 rounded p-1 text-center text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-400" value={recipeForm.markupPercent} onChange={(e) => { const m = parseFloat(e.target.value) || 0; const fee = parseFloat(recipeForm.extraFee) || 0; const newPrice = Math.ceil(currentCost * (1 + m/100) + fee); setRecipeForm({...recipeForm, markupPercent: m, sellingPrice: newPrice}); }} /><span className="text-sm text-blue-700 font-bold">%)</span></div>
                                        <div className="flex items-center space-x-1"><span className="text-sm text-blue-700 font-bold">+ å·¥éŒ¢</span><input type="number" className="w-14 border border-blue-300 rounded p-1 text-center text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-400" value={recipeForm.extraFee} onChange={(e) => { const m = parseFloat(recipeForm.markupPercent) || 0; const fee = parseFloat(e.target.value) || 0; const newPrice = Math.ceil(currentCost * (1 + m/100) + fee); setRecipeForm({...recipeForm, extraFee: fee, sellingPrice: newPrice}); }} /></div>
                                        <div className="w-full text-right text-xs text-blue-500">= å»ºè­°å”®åƒ¹ ${Math.ceil(currentCost * (1 + (recipeForm.markupPercent||0)/100) + (recipeForm.extraFee||0))}</div>
                                    </div>
                                    <div className="flex justify-between text-sm pt-2 border-t border-gray-200"><span>å–®ä»½æ¯›åˆ©:</span><span className={`font-bold ${profit > 0 ? 'text-green-600' : 'text-red-600'}`}>${profit.toFixed(1)}</span></div>
                                    <div className="flex justify-between text-sm"><span>æ¯›åˆ©ç‡:</span><span className={`font-bold ${margin >= 30 ? 'text-green-600' : 'text-orange-500'}`}>{margin.toFixed(1)}%</span></div>
                                </div>

                                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 className="font-bold text-green-800 mb-2 flex items-center"><Leaf size={16} className="mr-2"/> ç‡Ÿé¤Šæ¨™ç¤º (æ¯ä»½)</h4>
                                    {!nutritionData.hasData ? (<p className="text-xs text-gray-500">å°šç„¡æ•¸æ“š (è«‹ç¢ºä¿é£Ÿæå·²è¨­å®šç‡Ÿé¤Šæˆåˆ†)</p>) : (<div className="grid grid-cols-2 gap-y-1 gap-x-4 text-xs">{NUTRIENTS.map(nut => (<div key={nut.key} className="flex justify-between border-b border-green-100 pb-1"><span className="text-gray-600">{nut.label}</span><span className="font-bold text-green-700">{nutritionData.perServing[nut.key].toFixed(1)} {nut.unit}</span></div>))}</div>)}
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                    <div className="flex justify-between mb-2"><h4 className="font-bold text-sm text-indigo-800">æ‰€éœ€é£Ÿæ (ç¸½é‡)</h4><button onClick={() => setRecipeForm({ ...recipeForm, items: [...recipeForm.items, { id: ingredients[0]?.id || '', qty: 0 }] })} className="text-xs bg-white border border-indigo-200 px-2 py-1 rounded text-indigo-600">+ åŠ å…¥</button></div>
                                    <div className="max-h-60 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                                        {recipeForm.items.map((item, idx) => {
                                            const ing = (ingredients||[]).find(i => i.id === item.id) || (ingredients||[]).find(i => i.name === item.name);
                                            const itemCost = ing ? (ing.cost * item.qty) : 0;
                                            return (
                                            <div key={idx} className={`flex flex-col p-2 rounded border mb-1 ${!ing ? 'bg-red-50 border-red-200' : 'bg-white border-indigo-100'}`}>
                                                <div className="flex items-center space-x-1 mb-1">
                                                    <select className={`flex-1 text-xs p-1 border rounded ${!ing ? 'border-red-500 bg-red-50' : ''}`} value={item.id} onChange={e => { const n = [...recipeForm.items]; const selectedIng = ingredients.find(i => i.id === e.target.value); n[idx].id = e.target.value; n[idx].name = selectedIng ? selectedIng.name : ''; setRecipeForm({ ...recipeForm, items: n }) }}>
                                                        {!ing && <option value={item.id}>âŒ {item.name || 'æœªçŸ¥'} (é€£çµå¤±æ•ˆ)</option>}
                                                        {(ingredients||[]).map(i => <option key={i.id} value={i.id}>{i.name} (${(i.cost||0).toFixed(2)}/{i.unit})</option>)}
                                                    </select>
                                                    <input type="number" className="w-16 text-xs p-1 border rounded" placeholder="é‡" value={item.qty} onChange={e => { const n = [...recipeForm.items]; n[idx].qty = parseFloat(e.target.value) || 0; setRecipeForm({ ...recipeForm, items: n }) }} />
                                                    <button onClick={() => { const n = recipeForm.items.filter((_, i) => i !== idx); setRecipeForm({ ...recipeForm, items: n }) }} className="text-red-400"><X size={14} /></button>
                                                </div>
                                                <div className="text-[10px] text-gray-500 flex justify-between"><span>å–®åƒ¹: ${ing ? ing.cost.toFixed(4) : 0} x {item.qty}</span><span className="font-bold text-indigo-600">= ${itemCost.toFixed(2)}</span></div>
                                            </div>
                                        )})}
                                    </div>
                                </div>
                                <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                                    <div className="flex justify-between mb-2"><h4 className="font-bold text-sm text-yellow-800">æ‰€éœ€åŒ…æ (ç¸½é‡)</h4><button onClick={() => setRecipeForm({ ...recipeForm, packagingItems: [...(recipeForm.packagingItems || []), { id: packaging[0]?.id || '', qty: 0 }] })} className="text-xs bg-white border border-yellow-200 px-2 py-1 rounded text-yellow-600">+ åŠ å…¥</button></div>
                                    <div className="max-h-40 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                                        {recipeForm.packagingItems && recipeForm.packagingItems.map((item, idx) => {
                                            const pkg = (packaging||[]).find(p => p.id === item.id) || (packaging||[]).find(p => p.name === item.name);
                                            return (
                                            <div key={idx} className={`flex items-center space-x-1 mb-1 p-1 rounded border ${!pkg ? 'bg-red-50 border-red-200' : 'bg-white'}`}>
                                                <select className={`flex-1 text-xs p-1 border rounded ${!pkg ? 'border-red-500 bg-red-50' : ''}`} value={item.id} onChange={e => { const n = [...recipeForm.packagingItems]; const p = packaging.find(px=>px.id===e.target.value); n[idx].id = e.target.value; n[idx].name = p?p.name:''; setRecipeForm({ ...recipeForm, packagingItems: n }) }}>
                                                    {!pkg && <option value={item.id}>âŒ {item.name || 'æœªçŸ¥'} (é€£çµå¤±æ•ˆ)</option>}
                                                    {(packaging||[]).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                </select>
                                                <input type="number" className="w-16 text-xs p-1 border rounded" placeholder="é‡" value={item.qty} onChange={e => { const n = [...recipeForm.packagingItems]; n[idx].qty = parseFloat(e.target.value) || 0; setRecipeForm({ ...recipeForm, packagingItems: n }) }} />
                                                <button onClick={() => { const n = recipeForm.packagingItems.filter((_, i) => i !== idx); setRecipeForm({ ...recipeForm, packagingItems: n }) }} className="text-red-400"><X size={14} /></button>
                                            </div>
                                        )})}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end space-x-2 mt-6 pt-4 border-t">
                            <button onClick={() => setEditingId(null)} className="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button>
                            <button onClick={save} className="px-4 py-2 bg-indigo-600 text-white rounded shadow">å„²å­˜é£Ÿè­œ</button>
                        </div>
                    </Modal>
                );
            }

            return (
                <div className="space-y-4">
                    <div className="flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
                        <h2 className="text-2xl font-bold text-gray-800">é£Ÿè­œç®¡ç†</h2>
                        <div className="flex space-x-2">
                             <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx, .xls" className="hidden" />
                             <button onClick={handleImportClick} className="bg-green-600 text-white px-4 py-2 rounded shadow flex items-center hover:bg-green-700 text-sm"><Upload size={16} className="mr-1" /> åŒ¯å…¥ Excel</button>
                             {/* ğŸ”¥ V140: æ–°å¢æ¸…ç©ºæŒ‰éˆ• */}
                             {recipes.length > 0 && <button onClick={confirmClearAll} className="bg-red-500 text-white px-3 py-2 rounded shadow flex items-center hover:bg-red-600 text-sm"><Trash2 size={16} className="mr-1" /> æ¸…ç©º</button>}
                             <button onClick={startNew} className="bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center hover:bg-indigo-700 text-sm"><Plus size={16} className="mr-1" /> æ–°å¢</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(recipes||[]).map(recipe => {
                            const cost = calculateCost(recipe);
                            const profit = recipe.sellingPrice - cost;
                            // ğŸ”¥ V140: æª¢æŸ¥é€£çµå¥åº·åº¦
                            const isBroken = checkRecipeHealth(recipe);

                            return (
                                <Card key={recipe.id} className="p-4 flex flex-col justify-between group">
                                    <div>
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-lg text-gray-800 flex items-center">
                                                {/* ğŸ”¥ V140: è‹¥æœ‰å•é¡Œé¡¯ç¤ºç´…é©šå˜†è™Ÿ */}
                                                {isBroken && <AlertCircle size={18} className="text-red-500 mr-1 animate-pulse" title="é€£çµå¤±æ•ˆï¼šè«‹æª¢æŸ¥é£Ÿææˆ–åŒ…ææ˜¯å¦åœ¨åº«å­˜ä¸­"/>}
                                                {recipe.name}
                                            </h3>
                                            <Badge color="indigo">{recipe.category}</Badge>
                                        </div>
                                        <div className="space-y-1 text-sm text-gray-600 mb-4">
                                            <div className="flex justify-between"><span>å”®åƒ¹:</span><span className="font-bold text-gray-900">${recipe.sellingPrice}</span></div>
                                            <div className="flex justify-between"><span>æˆæœ¬(ä¼°):</span><span>${cost.toFixed(1)}</span></div>
                                            <div className="flex justify-between pt-1 border-t border-dashed"><span>é ä¼°æ¯›åˆ©:</span><span className={profit > 0 ? 'text-green-600 font-bold' : 'text-red-500 font-bold'}>${profit.toFixed(1)}</span></div>
                                            {recipe.markupPercent > 0 && <div className="text-xs bg-blue-50 text-blue-600 px-1 rounded inline-block mt-1">æˆæœ¬ x (1+{recipe.markupPercent}%)</div>}
                                        </div>
                                    </div>
                                    <div className="flex space-x-2 mt-auto">
                                        <button onClick={() => startEdit(recipe)} className={`flex-1 py-1.5 rounded text-sm flex justify-center items-center ${isBroken ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><Edit3 size={14} className="mr-1" /> {isBroken ? 'ä¿®å¾©é€£çµ' : 'ç·¨è¼¯'}</button>
                                        <button onClick={() => onDelete(recipe.id)} className="px-3 bg-red-50 text-red-500 rounded border border-red-200 hover:bg-red-100 flex items-center justify-center">
                                            <Trash2 size={16} color="#ef4444" className="mr-1"/> <span className="text-red-500 text-xs font-bold">åˆªé™¤</span>
                                        </button>
                                    </div>
                                </Card>
                            )
                        })}
                    </div>
                </div>
            );
        };

      // --- OrderManager (V137 - CRM Sort by Frequency) ---
        // ä¿®æ”¹ï¼šå®¢æˆ¶åˆ†æ (CRM) æ”¹ç‚ºé è¨­ä¾ç…§ã€Œè¨‚è³¼æ¬¡æ•¸ã€ç”±é«˜åˆ°ä½æ’åº (æ¬¡æ•¸ç›¸åŒå‰‡æ¯”é‡‘é¡)
        const OrderManager = ({ orders, recipes, ingredients, packaging, onSave, onDelete, onUpdateStatus }) => {
            const [activeView, setActiveView] = useState('list'); // 'list' | 'crm'
            const [isCreating, setIsCreating] = useState(false);
            const [newOrder, setNewOrder] = useState({ customer: '', store: '', shippingFee: 0, packagingFee: 0, items: [], note: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [previewOrders, setPreviewOrders] = useState([]);
            const [showImportPreview, setShowImportPreview] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);

            const safeOrders = useMemo(() => Array.isArray(orders) ? orders : [], [orders]);
            const safeRecipes = useMemo(() => Array.isArray(recipes) ? recipes : [], [recipes]);

            const filteredOrders = useMemo(() => {
                let result = safeOrders;
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    result = safeOrders.filter(o => {
                        if (!o) return false;
                        const cust = String(o.customer || '').toLowerCase();
                        const date = String(o.date || '');
                        const store = String(o.store || '').toLowerCase();
                        return cust.includes(lowerTerm) || date.includes(lowerTerm) || store.includes(lowerTerm);
                    });
                }
                return result.sort((a, b) => {
                    const dateDiff = new Date(b.date || 0) - new Date(a.date || 0);
                    if (dateDiff !== 0) return dateDiff;
                    return String(b.id).localeCompare(String(a.id));
                });
            }, [safeOrders, searchTerm]);

            // ğŸ”¥ V137 å„ªåŒ–ï¼šCRM æ’åºé‚è¼¯èª¿æ•´
            const customerAnalysis = useMemo(() => {
                const customers = {};
                safeOrders.forEach(order => {
                    if (!order || typeof order !== 'object') return;
                    if (order.status !== 'completed') return;

                    const custName = order.customer ? String(order.customer).trim() : 'æœªçŸ¥å®¢æˆ¶';
                    const storeName = order.store ? String(order.store).trim() : 'ç„¡é–€å¸‚';
                    const key = `${custName}_${storeName}`;
                    
                    if (!customers[key]) {
                        customers[key] = { id: key, name: custName, store: storeName, totalSpend: 0, orderCount: 0, lastOrderDate: order.date || '', productCounts: {} };
                    }
                    
                    const cust = customers[key];
                    const amt = parseFloat(order.totalAmount);
                    cust.totalSpend += isNaN(amt) ? 0 : amt;
                    cust.orderCount += 1;
                    
                    if (order.date) {
                        if (!cust.lastOrderDate || new Date(order.date) > new Date(cust.lastOrderDate)) {
                            cust.lastOrderDate = order.date;
                        }
                    }

                    if (Array.isArray(order.items)) {
                        order.items.forEach(item => {
                            if (!item) return;
                            let pName = 'æœªçŸ¥å•†å“';
                            const r = safeRecipes.find(rec => rec.id === item.recipeId);
                            if (r && r.name) pName = r.name;
                            else if (item.recipeName) pName = item.recipeName;
                            
                            if (!cust.productCounts[pName]) cust.productCounts[pName] = 0;
                            const qty = parseFloat(item.qty);
                            cust.productCounts[pName] += isNaN(qty) ? 0 : qty;
                        });
                    }
                });

                return Object.values(customers).map(c => {
                    const topProducts = Object.entries(c.productCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3)
                        .map(([name, qty]) => ({ name, qty }));

                    let tag = 'ğŸŒ± æ–°å®¢';
                    let tagColorClass = 'bg-gray-500';
                    if (c.orderCount >= 5) { tag = 'ğŸ‘‘ VIP'; tagColorClass = 'bg-yellow-500'; }
                    else if (c.orderCount >= 2) { tag = 'â¤ï¸ å›è³¼å®¢'; tagColorClass = 'bg-pink-500'; }

                    return { ...c, avgOrderValue: c.orderCount > 0 ? Math.round(c.totalSpend / c.orderCount) : 0, topProducts, tag, tagColorClass };
                })
                // ğŸ”¥ V137 ä¿®æ”¹æ’åºï¼šå…ˆæ¯”æ¬¡æ•¸(å¤§åˆ°å°)ï¼Œæ¬¡æ•¸ä¸€æ¨£æ¯”ç¸½é‡‘é¡(å¤§åˆ°å°)
                .sort((a, b) => {
                    if (b.orderCount !== a.orderCount) {
                        return b.orderCount - a.orderCount;
                    }
                    return b.totalSpend - a.totalSpend;
                });
            }, [safeOrders, safeRecipes]);

            const handleAddItem = () => { 
                if (safeRecipes.length === 0) return alert('è«‹å…ˆå»ºç«‹é£Ÿè­œ'); 
                setNewOrder({...newOrder, items: [...(newOrder.items||[]), { recipeId: safeRecipes[0].id, qty: 1, price: safeRecipes[0].sellingPrice }]}); 
            };
            
            const calculateTotal = (order) => { 
                if (!order || !Array.isArray(order.items)) return 0;
                const itemsTotal = order.items.reduce((acc, item) => {
                    const price = parseFloat(item.price) || 0;
                    const qty = parseFloat(item.qty) || 0;
                    return acc + (price * qty);
                }, 0); 
                const ship = parseFloat(order.shippingFee) || 0;
                const pkg = parseFloat(order.packagingFee) || 0;
                return itemsTotal + ship + pkg;
            };
            
            const openEditModal = (order) => { setEditingId(order.id); setNewOrder(order); setIsCreating(true); };
            
            const submitOrder = () => { 
                if (!newOrder.customer) return alert('è«‹è¼¸å…¥å®¢æˆ¶åç¨±'); 
                if (!newOrder.items || newOrder.items.length === 0) return alert('è«‹åŠ å…¥å•†å“'); 
                const finalOrder = { ...newOrder, totalAmount: calculateTotal(newOrder) };
                if (!editingId) { finalOrder.date = new Date().toISOString().split('T')[0]; finalOrder.status = 'pending'; }
                if (editingId && newOrder.status) finalOrder.status = newOrder.status;
                onSave(finalOrder, editingId); closeModal();
            };
            
            const closeModal = () => { setIsCreating(false); setEditingId(null); setNewOrder({ customer: '', store: '', shippingFee: 0, packagingFee: 0, items: [], note: '' }); };
            const handleImportClick = () => fileInputRef.current.click();
            
            const handleForceComplete = (order) => {
                if(!confirm("é€™å°‡æœƒæŠŠè¨‚å–®è¨­ç‚ºã€Œå·²å®Œæˆã€ï¼Œä½†ã€ä¸æœƒã€‘å†æ¬¡æ‰£é™¤åº«å­˜ã€‚\n\né©ç”¨æ–¼ï¼šåŒ¯å…¥èˆŠè³‡æ–™ã€æˆ–å·²ç¶“æ‰‹å‹•æ‰£éåº«å­˜çš„è¨‚å–®ã€‚\n\nç¢ºå®šå—ï¼Ÿ")) return;
                onSave({ ...order, status: 'completed' }, order.id);
            };

            const handleFileUpload = async (e) => { 
                const file = e.target.files[0]; if (!file) return; 
                try { 
                    if (!window.XLSX) await loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"); 
                    const reader = new FileReader(); 
                    reader.onload = (evt) => { 
                        const data = new Uint8Array(evt.target.result); 
                        const workbook = window.XLSX.read(data, { type: 'array', cellDates: true }); 
                        const jsonData = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); 
                        processExcelData(jsonData); 
                    }; 
                    reader.readAsArrayBuffer(file); 
                } catch (error) { console.error(error); alert("åŒ¯å…¥å¤±æ•—: " + error.message); } e.target.value = ''; 
            };
            
            const processExcelData = (rows) => {
                const groupedOrders = {};
                const findKey = (row, keywords) => { 
                    const keys = Object.keys(row); 
                    for (const kw of keywords) { 
                        if (row[kw] !== undefined) return row[kw]; 
                        const foundKey = keys.find(k => k.replace(/\s/g, '').includes(kw.replace(/\s/g, ''))); 
                        if (foundKey) return row[foundKey]; 
                    } 
                    return undefined; 
                };

                const parseExcelDate = (val) => {
                    if (!val) return new Date().toISOString().split('T')[0];
                    let dateObj = null;
                    if (val instanceof Date) { dateObj = val; } 
                    else if (typeof val === 'string') { dateObj = new Date(val); } 
                    else if (typeof val === 'number') { dateObj = new Date(Math.round((val - 25569) * 86400 * 1000)); }
                    if (!dateObj || isNaN(dateObj.getTime())) return new Date().toISOString().split('T')[0];
                    const offset = dateObj.getTimezoneOffset() * 60000;
                    const localDate = new Date(dateObj.getTime() - offset);
                    return localDate.toISOString().split('T')[0];
                };

                rows.forEach(row => {
                    const rawDate = findKey(row, ['è¨‚è³¼æ—¥æœŸ', 'æ—¥æœŸ']);
                    const date = parseExcelDate(rawDate);
                    const customer = String(findKey(row, ['æ”¶ä»¶äººå§“å', 'æ”¶ä»¶äºº', 'å®¢æˆ¶åç¨±']) || 'æœªçŸ¥å®¢æˆ¶').trim();
                    const store = String(findKey(row, ['å–è²¨é–€å¸‚', 'é–€å¸‚', 'å–è²¨åœ°å€']) || '').trim(); 
                    const productName = findKey(row, ['å•†å“åç¨±', 'å“å', 'å“å/è¦æ ¼']);
                    const price = parseFloat(findKey(row, ['åƒ¹æ ¼', 'å–®åƒ¹']) || 0);
                    const qty = parseInt(findKey(row, ['æ•¸é‡']) || 1);
                    const shipping = parseFloat(findKey(row, ['é‹è²»', 'é‹è²»(B)']) || 0);
                    
                    let recipeId = `UNKNOWN_${productName || 'unknown'}`;
                    let finalPrice = price;
                    
                    if (safeRecipes.length > 0 && productName) {
                        const recipe = safeRecipes.find(r => r.name.trim() === String(productName).trim());
                        if (recipe) {
                            recipeId = recipe.id;
                            if (finalPrice === 0) finalPrice = recipe.sellingPrice;
                        }
                    }

                    const key = `${date}_${customer}`;
                    if (!groupedOrders[key]) { 
                        groupedOrders[key] = { date, customer, store, shippingFee: shipping, packagingFee: 0, status: 'pending', items: [], totalAmount: 0 }; 
                    } else {
                        if (!groupedOrders[key].store && store) { groupedOrders[key].store = store; }
                        if (shipping > groupedOrders[key].shippingFee) { groupedOrders[key].shippingFee = shipping; }
                    }
                    
                    if (productName) { groupedOrders[key].items.push({ recipeId, recipeName: productName, qty, price: finalPrice }); }
                });
                
                const parsedList = Object.values(groupedOrders).map(order => { 
                    order.totalAmount = calculateTotal(order); 
                    const hasUnknown = order.items.some(i => i.recipeId && i.recipeId.startsWith('UNKNOWN')); 
                    if (hasUnknown) { order.note = "âš ï¸ æ³¨æ„ï¼šåŒ…å«æœªçŸ¥å•†å“"; order.hasError = true; } 
                    return order; 
                });
                
                if (parsedList.length > 0) { setPreviewOrders(parsedList); setShowImportPreview(true); } 
                else { alert("æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„è¨‚å–®è³‡æ–™ã€‚"); }
            };
            
            const confirmImport = () => { 
                let importCount = 0; 
                previewOrders.forEach(order => { const { hasError, ...cleanOrder } = order; onSave(cleanOrder); importCount++; }); 
                alert(`æˆåŠŸåŒ¯å…¥ ${importCount} ç­†è¨‚å–®ï¼`); setShowImportPreview(false); setPreviewOrders([]); 
            };

            if (showImportPreview) { return (<Modal title="åŒ¯å…¥é è¦½" onClose={() => setShowImportPreview(false)}><div className="space-y-4">{previewOrders.map((order, idx) => (<div key={idx} className={`bg-white rounded-lg p-4 shadow-sm border-l-4 ${order.hasError ? 'border-red-500' : 'border-green-500'}`}><div className="flex justify-between"><div className="font-bold">{order.customer} <span className="text-xs text-gray-400 font-normal">{order.date}</span></div><div className="font-bold text-indigo-600">${order.totalAmount}</div></div><div className="text-sm mt-2">{order.items.map((i, k) => <div key={k}>{i.recipeName} x{i.qty}</div>)}</div>{order.store && <div className="text-xs text-gray-500 mt-1 flex items-center"><Store size={10} className="mr-1"/>{order.store}</div>}</div>))}</div><div className="pt-4 flex justify-end space-x-3"><button onClick={() => setShowImportPreview(false)} className="px-6 py-2 bg-gray-100 rounded-lg">å–æ¶ˆ</button><button onClick={confirmImport} className="px-6 py-2 bg-indigo-600 text-white rounded-lg">ç¢ºèªåŒ¯å…¥</button></div></Modal>); }
            
            if (isCreating) {
                return (
                    <Modal title={editingId ? "ç·¨è¼¯è¨‚å–®" : "å»ºç«‹æ–°è¨‚å–®"} onClose={closeModal}>
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-gray-700">å®¢æˆ¶å§“å</label><input className="w-full border p-2 rounded mt-1" value={newOrder.customer} onChange={e => setNewOrder({...newOrder, customer: e.target.value})} /></div><div><label className="block text-sm font-bold text-gray-700">å–è²¨é–€å¸‚</label><input className="w-full border p-2 rounded mt-1" value={newOrder.store} onChange={e => setNewOrder({...newOrder, store: e.target.value})} /></div></div>
                            <div>
                                <div className="flex justify-between items-center mb-2"><label className="block text-sm font-bold text-gray-700">è¨‚è³¼å•†å“</label><button onClick={handleAddItem} className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">+ åŠ å…¥å•†å“</button></div>
                                {newOrder.items && newOrder.items.map((item, idx) => (
                                    <div key={idx} className="flex space-x-2 mb-2 items-center">
                                            <select className="flex-1 border p-2 rounded" value={item.recipeId} onChange={e => { const r = safeRecipes.find(rec => rec.id === e.target.value); const newItems = [...newOrder.items]; newItems[idx].recipeId = e.target.value; newItems[idx].price = r ? r.sellingPrice : 0; setNewOrder({...newOrder, items: newItems}); }}>{safeRecipes.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select>
                                            <input type="number" className="w-16 border p-2 rounded text-center" value={item.qty} onChange={v => { const newItems = [...newOrder.items]; newItems[idx].qty = parseInt(v.target.value) || 1; setNewOrder({...newOrder, items: newItems}); }} placeholder="é‡"/>
                                            <button onClick={() => { const newItems = newOrder.items.filter((_, i) => i !== idx); setNewOrder({...newOrder, items: newItems}); }} className="text-red-400"><Trash2 size={18} /></button>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div><label className="block text-sm font-bold text-gray-700">é‹è²» (å‘å®¢äººæ”¶)</label><SafeNumberInput className="w-full border p-2 rounded mt-1" value={newOrder.shippingFee} onChange={v => setNewOrder({...newOrder, shippingFee: parseFloat(v) || 0})} /></div>
                                <div><label className="block text-sm font-bold text-indigo-700">åŠ æ”¶åŒ…æè²» (å‘å®¢äººæ”¶)</label><SafeNumberInput className="w-full border p-2 rounded mt-1 text-indigo-700 font-bold" value={newOrder.packagingFee} onChange={v => setNewOrder({...newOrder, packagingFee: parseFloat(v) || 0})} placeholder="0"/><p className="text-[10px] text-gray-400 mt-1">*æ­¤é‡‘é¡æœƒåŠ ç¸½è‡³ç¸½é‡‘é¡</p></div>
                            </div>
                            <div className="text-right font-bold text-lg mt-4 text-indigo-600 bg-gray-50 p-2 rounded">ç¸½é‡‘é¡: ${calculateTotal(newOrder)}</div>
                            <div className="flex justify-end space-x-3 border-t pt-4 mt-4"><button onClick={closeModal} className="px-6 py-2 bg-gray-200 rounded-lg font-bold text-gray-600">å–æ¶ˆ</button><button onClick={submitOrder} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-lg hover:bg-indigo-700">å„²å­˜è¨‚å–®</button></div>
                        </div>
                    </Modal>
                );
            }

            return (
                <div className="space-y-4">
                    <div className="flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
                        <div className="flex items-center space-x-4">
                            <h2 className="text-2xl font-bold text-gray-800">è¨‚å–®ç®¡ç†</h2>
                            <div className="bg-gray-100 p-1 rounded-lg flex space-x-1">
                                <button onClick={() => setActiveView('list')} className={`px-3 py-1.5 rounded-md text-sm font-bold transition-all flex items-center ${activeView === 'list' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}`}><ClipboardList size={16} className="mr-1"/> è¨‚å–®åˆ—è¡¨</button>
                                <button onClick={() => setActiveView('crm')} className={`px-3 py-1.5 rounded-md text-sm font-bold transition-all flex items-center ${activeView === 'crm' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:text-gray-700'}`}><Users size={16} className="mr-1"/> å®¢æˆ¶åˆ†æ (CRM)</button>
                            </div>
                        </div>
                        {activeView === 'list' && (
                            <div className="flex space-x-2">
                                <div className="relative"><Search className="absolute left-3 top-2.5 text-gray-400" size={16} /><input type="text" placeholder="æœå°‹..." className="pl-9 pr-3 py-2 border rounded-lg text-sm w-48 focus:ring-2 focus:ring-indigo-500 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} />
                                <button onClick={handleImportClick} className="bg-green-600 text-white px-3 py-2 rounded-lg flex items-center shadow hover:bg-green-700 whitespace-nowrap"><Upload size={18} className="mr-1 hidden md:block" /> åŒ¯å…¥</button>
                                <button onClick={() => { setEditingId(null); setNewOrder({ customer: '', store: '', shippingFee: 0, packagingFee: 0, items: [], note: '' }); setIsCreating(true); }} className="bg-indigo-600 text-white px-3 py-2 rounded-lg flex items-center shadow hover:bg-indigo-700 whitespace-nowrap"><Plus size={18} className="mr-1 hidden md:block" /> æ–°å¢</button>
                            </div>
                        )}
                    </div>

                    {activeView === 'list' && (
                        <div className="grid grid-cols-1 gap-4">
                            {filteredOrders.length === 0 && <p className="text-center text-gray-400 py-10">{searchTerm ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨‚å–®' : 'å°šç„¡è¨‚å–®'}</p>}
                            {filteredOrders.map(order => {
                                // Calculate financial data for this order
                                const { cost, profit } = calculateOrderFinancials(order, recipes, ingredients, packaging);
                                const profitMargin = order.totalAmount > 0 ? (profit / order.totalAmount) * 100 : 0;

                                return (
                                <div key={order.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-start hover:border-indigo-200 transition-colors">
                                    <div className="w-full md:w-3/4">
                                        <div className="flex items-center space-x-2 flex-wrap mb-3">
                                            <span className="font-bold text-lg text-gray-800">{order.customer}</span>
                                            <Badge color={order.status === 'completed' ? 'green' : 'yellow'}>{order.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…è™•ç†'}</Badge>
                                            <span className="text-xs text-gray-400 flex items-center"><Calendar size={12} className="mr-1"/>{order.date}</span>
                                            {order.store && <span className="text-xs text-gray-500 flex items-center bg-gray-100 px-2 py-0.5 rounded"><Store size={10} className="mr-1"/>{order.store}</span>}
                                        </div>
                                        <div className="bg-gray-50 rounded-lg p-3 text-sm space-y-2 border border-gray-100">
                                            {(order.items && order.items.length > 0) ? order.items.map((item, idx) => { 
                                                let rName = '(å·²åˆªé™¤çš„é£Ÿè­œ)';
                                                if (safeRecipes && Array.isArray(safeRecipes)) { const r = safeRecipes.find(rec => rec.id === item.recipeId); if (r) rName = r.name; else if (item.recipeName) rName = item.recipeName; } else if (item.recipeName) { rName = item.recipeName; }
                                                const isUnknown = rName === '(å·²åˆªé™¤çš„é£Ÿè­œ)'; 
                                                return (<div key={idx} className={`flex justify-between items-center ${isUnknown ? 'text-red-400' : 'text-gray-700'}`}><div className="flex items-center"><div className={`w-1 h-1 rounded-full mr-2 ${isUnknown ? 'bg-red-400' : 'bg-gray-400'}`}></div><span className="font-medium">{rName}</span><span className="text-gray-400 mx-2">x</span><span className="font-bold">{item.qty}</span></div><span className="text-gray-500">${(item.price * item.qty).toLocaleString()}</span></div>); 
                                            }) : <div className="text-gray-400 text-center py-2">ç„¡å•†å“è³‡æ–™</div>}
                                            <div className="border-t border-gray-200 pt-2 space-y-1"><div className="flex justify-between items-center text-gray-500 text-xs"><span>é‹è²»</span><span>${order.shippingFee || 0}</span></div>{order.packagingFee > 0 && (<div className="flex justify-between items-center text-indigo-500 text-xs"><span>åŒ…æè²»</span><span>+${order.packagingFee}</span></div>)}</div>
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end space-y-2 w-full md:w-auto mt-4 md:mt-0 pl-4 md:border-l border-gray-100 h-full justify-center">
                                        <div className="text-xs text-gray-400">ç¸½é‡‘é¡</div>
                                        <div className="font-bold text-indigo-600 text-2xl">${order.totalAmount ? order.totalAmount.toLocaleString() : 0}</div>
                                        
                                        {/* New Cost/Profit Display */}
                                        <div className="text-xs text-right w-full mb-2 bg-slate-50 p-2 rounded">
                                            <div className="text-gray-400 mb-1">æˆæœ¬: ${Math.round(cost).toLocaleString()}</div>
                                            <div className={profit >= 0 ? "text-green-600 font-bold" : "text-red-500 font-bold"}>
                                                æ·¨åˆ©: ${Math.round(profit).toLocaleString()} <span className="text-[10px] opacity-70">({profitMargin.toFixed(0)}%)</span>
                                            </div>
                                        </div>

                                        {order.status === 'pending' && (
                                            <div className="w-full space-y-2 mb-2">
                                                <button onClick={() => onUpdateStatus(order, 'completed')} className="w-full bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow-sm text-sm hover:bg-green-700 w-full justify-center"><CheckCircle size={16} className="mr-1" /> å®Œæˆä¸¦æ‰£åº«å­˜</button>
                                                <button onClick={() => handleForceComplete(order)} className="w-full bg-gray-100 text-gray-600 px-4 py-2 rounded-lg flex items-center shadow-sm text-xs hover:bg-gray-200 w-full justify-center border border-gray-200"><FileText size={14} className="mr-1" /> è£œç™» (ä¸æ‰£åº«å­˜)</button>
                                            </div>
                                        )}
                                        <div className="flex space-x-2 w-full">
                                            <button onClick={() => openEditModal(order)} className="flex-1 bg-indigo-50 text-indigo-600 py-1.5 rounded-lg text-sm hover:bg-indigo-100 flex items-center justify-center font-medium shadow-sm border border-indigo-100"><Edit3 size={16} className="mr-1"/> ä¿®æ”¹</button>
                                            <button onClick={() => onDelete(order.id)} className="flex-1 bg-white border border-red-200 text-red-500 py-1.5 rounded-lg text-sm hover:bg-red-50 flex items-center justify-center font-medium shadow-sm"><Trash2 size={16} className="mr-1"/> åˆªé™¤</button>
                                        </div>
                                    </div>
                                </div>
                            )})}
                        </div>
                    )}

                    {activeView === 'crm' && (
                        <div className="space-y-4">
                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 text-purple-800 text-sm flex items-center"><Heart className="mr-2 text-purple-600" size={20}/> <span>å®¢æˆ¶åˆ†æçµ±è¨ˆç¯„åœï¼š<strong>åƒ…é™ã€Œå·²å®Œæˆ (Completed)ã€çš„è¨‚å–®</strong>ã€‚</span></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {customerAnalysis.map((cust) => (
                                    <Card key={cust.id} className="p-4 hover:shadow-md transition-shadow relative overflow-hidden">
                                            <div className={`absolute top-0 right-0 p-1.5 rounded-bl-xl text-xs font-bold text-white ${cust.tagColorClass}`}>{cust.tag}</div>
                                            <div className="flex items-center mb-3"><div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold mr-3 ${cust.tag === 'ğŸ‘‘ VIP' ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-500'}`}>{cust.name.charAt(0)}</div><div><h3 className="font-bold text-lg text-gray-800">{cust.name}</h3><p className="text-xs text-gray-500 flex items-center"><Store size={10} className="mr-1"/> {cust.store}</p></div></div>
                                            <div className="grid grid-cols-3 gap-2 text-center bg-gray-50 p-2 rounded-lg mb-3"><div><p className="text-[10px] text-gray-400">ç¸½æ¶ˆè²»</p><p className="font-bold text-indigo-600">${cust.totalSpend.toLocaleString()}</p></div><div><p className="text-[10px] text-gray-400">è¨‚è³¼æ¬¡æ•¸</p><p className="font-bold text-gray-700">{cust.orderCount} æ¬¡</p></div><div><p className="text-[10px] text-gray-400">å®¢å–®åƒ¹</p><p className="font-bold text-gray-700">${cust.avgOrderValue}</p></div></div>
                                            <div><p className="text-xs font-bold text-gray-500 mb-1 flex items-center"><Heart size={10} className="mr-1"/> è³¼è²·å–œå¥½ (Top 3)</p><div className="space-y-1">{cust.topProducts.map((p, i) => (<div key={i} className="flex justify-between text-sm items-center"><span className="truncate flex-1 text-gray-700">{p.name}</span><span className="text-xs bg-indigo-50 text-indigo-600 px-1.5 rounded-full">x{p.qty}</span></div>))}</div></div>
                                            <div className="mt-3 pt-2 border-t border-gray-100 text-[10px] text-gray-400 text-right">æœ€å¾Œè¨‚è³¼æ—¥: {cust.lastOrderDate}</div>
                                    </Card>
                                ))}
                                {customerAnalysis.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">å°šç„¡å·²å®Œæˆçš„è¨‚å–®è³‡æ–™</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- StallManager (V144 - Edit Mode Fix) ---
        const StallManager = ({ stalls, recipes, ingredients, packaging, onSave, onDelete, onDeductStock }) => {
            const [editingId, setEditingId] = useState(null);
            const [stallForm, setStallForm] = useState({ name: '', location: '', startDate: '', endDate: '', boothFee: 0, miscFee: 0, products: [], gifts: [], status: 'pending' });

            const safeStallsList = (Array.isArray(stalls) ? stalls : [])
                .filter(s => s !== null && s !== undefined)
                .sort((a, b) => {
                    const dateA = new Date(a.startDate || a.date || 0).getTime();
                    const dateB = new Date(b.startDate || b.date || 0).getTime();
                    return dateB - dateA;
                });

            const getDetailedCost = (recipeId) => {
                const r = recipes.find(rc => rc.id === recipeId);
                if (!r) return { ingCostPerPortion: 0, pkgCostPerPortion: 0, totalPerPortion: 0, yieldCount: 1 };
                
                let ingCostBatch = 0;
                let pkgCostBatch = 0;
                
                (r.items || []).forEach(item => {
                    const ing = ingredients.find(i => i.id === item.id) || ingredients.find(i => i.name === item.name);
                    if (ing) { ingCostBatch += (ing.cost || 0) * item.qty; }
                });

                (r.packagingItems || []).forEach(item => {
                    const pkg = packaging.find(p => p.id === item.id) || packaging.find(p => p.name === item.name);
                    if (pkg) { pkgCostBatch += (pkg.cost || 0) * item.qty; }
                });

                const yieldCount = parseFloat(r.yieldCount) || 1;
                
                return {
                    ingCostPerPortion: ingCostBatch / yieldCount,
                    pkgCostPerPortion: pkgCostBatch / yieldCount,
                    totalPerPortion: (ingCostBatch + pkgCostBatch) / yieldCount,
                    yieldCount: yieldCount
                };
            };

            const startEdit = (stall) => {
                try {
                    setEditingId(stall.id);
                    let form = JSON.parse(JSON.stringify(stall));
                    if (!form.startDate) form.startDate = form.date || '';
                    if (!form.endDate) form.endDate = form.date || '';
                    if (!form.miscFee) form.miscFee = 0;
                    
                    form.products = (form.products || []).map(p => ({ 
                        ...p, 
                        unit: p.unit || 'portion', 
                        discount: p.discount || 0 
                    }));
                    
                    form.gifts = (form.gifts || []).map(g => ({ 
                        ...g, 
                        note: g.note || ''
                    }));
                    
                    setStallForm(form);
                } catch (e) {
                    console.error("ç·¨è¼¯è¼‰å…¥å¤±æ•—", e);
                    alert("è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            };

            const startNew = () => {
                setEditingId('new');
                setStallForm({ 
                    name: '', location: '', 
                    startDate: new Date().toISOString().split('T')[0], 
                    endDate: new Date().toISOString().split('T')[0], 
                    boothFee: 0, miscFee: 0, 
                    products: [], gifts: [], 
                    status: 'pending' 
                });
            };

            const calculateDynamicStats = (form) => {
                let estRevenue = 0;
                let estTotalCost = 0; 
                let totalIngCost = 0;
                let totalPkgCost = 0;

                (form.products || []).forEach(p => {
                    const rowRevenue = ((p.soldQty || 0) * (p.price || 0)) - (p.discount || 0);
                    estRevenue += rowRevenue;

                    const breakdown = getDetailedCost(p.recipeId);
                    const totalQty = (p.soldQty || 0) + (p.wasteQty || 0) + (p.tastingQty || 0);
                    
                    const thisIngCost = totalQty * breakdown.ingCostPerPortion;
                    const thisPkgCost = totalQty * breakdown.pkgCostPerPortion;
                    
                    totalIngCost += thisIngCost;
                    totalPkgCost += thisPkgCost;
                    estTotalCost += (thisIngCost + thisPkgCost);
                });

                (form.gifts || []).forEach(g => {
                     const breakdown = getDetailedCost(g.recipeId);
                     const thisIngCost = (g.qty || 0) * breakdown.ingCostPerPortion;
                     const thisPkgCost = (g.qty || 0) * breakdown.pkgCostPerPortion;
                     totalIngCost += thisIngCost;
                     totalPkgCost += thisPkgCost;
                     estTotalCost += (thisIngCost + thisPkgCost);
                });

                const fixedFee = (parseFloat(form.boothFee) || 0) + (parseFloat(form.miscFee) || 0);
                estTotalCost += fixedFee;

                return { revenue: estRevenue, totalCost: estTotalCost, netProfit: estRevenue - estTotalCost, totalIngCost, totalPkgCost, fixedFee };
            };

            const save = () => {
                if (!stallForm.name) return alert('è«‹è¼¸å…¥æ´»å‹•åç¨±');
                const stats = calculateDynamicStats(stallForm);
                onSave({ ...stallForm, totalRevenue: stats.revenue, totalCost: stats.totalCost }, editingId === 'new' ? null : editingId);
                setEditingId(null);
            };

            const addProduct = () => {
                const r = recipes[0];
                if (!r) return alert('è«‹å…ˆå»ºç«‹é£Ÿè­œ');
                setStallForm({
                    ...stallForm,
                    products: [...stallForm.products, { recipeId: r.id, price: r.sellingPrice, prepareQty: 0, soldQty: 0, wasteQty: 0, tastingQty: 0, unit: 'portion', discount: 0 }]
                });
            };

            const addGift = () => {
                const r = recipes[0];
                if (!r) return alert('è«‹å…ˆå»ºç«‹é£Ÿè­œ');
                setStallForm({
                    ...stallForm,
                    gifts: [...stallForm.gifts, { recipeId: r.id, qty: 1, note: '' }]
                });
            };

            if (editingId) {
                const stats = calculateDynamicStats(stallForm);

                return (
                    <Modal title={editingId === 'new' ? 'æ–°å¢æ“ºæ”¤' : 'ç·¨è¼¯æ“ºæ”¤'} onClose={() => setEditingId(null)}>
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label className="text-xs text-gray-500">æ´»å‹•åç¨±</label><input className="w-full border p-2 rounded" value={stallForm.name} onChange={e => setStallForm({ ...stallForm, name: e.target.value })} /></div>
                                <div><label className="text-xs text-gray-500">åœ°é»</label><input className="w-full border p-2 rounded" value={stallForm.location} onChange={e => setStallForm({ ...stallForm, location: e.target.value })} /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 bg-gray-50 p-2 rounded">
                                <div><label className="text-xs text-gray-500">é–‹å§‹æ—¥æœŸ</label><input type="date" className="w-full border p-2 rounded" value={stallForm.startDate} onChange={e => setStallForm({ ...stallForm, startDate: e.target.value })} /></div>
                                <div><label className="text-xs text-gray-500">çµæŸæ—¥æœŸ</label><input type="date" className="w-full border p-2 rounded" value={stallForm.endDate} onChange={e => setStallForm({ ...stallForm, endDate: e.target.value })} /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 bg-red-50 p-2 rounded border border-red-100">
                                <div><label className="text-xs text-red-700 font-bold">æ”¤ä½è²»</label><SafeNumberInput className="w-full border p-2 rounded" value={stallForm.boothFee} onChange={v => setStallForm({ ...stallForm, boothFee: v })} /></div>
                                <div><label className="text-xs text-red-700 font-bold">é›œæ”¯/å…¶ä»–è²»ç”¨</label><SafeNumberInput className="w-full border p-2 rounded" value={stallForm.miscFee} onChange={v => setStallForm({ ...stallForm, miscFee: v })} /></div>
                            </div>
                            
                            <div className="bg-white border rounded-xl overflow-hidden">
                                <div className="bg-indigo-50 p-3 border-b flex justify-between items-center">
                                    <h4 className="font-bold text-indigo-800">è²©å”®å•†å“ (æœ‰ç‡Ÿæ”¶)</h4>
                                    <button onClick={addProduct} className="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded shadow">+ åŠ å…¥å•†å“</button>
                                </div>
                                <div className="p-3 space-y-4 max-h-80 overflow-y-auto custom-scrollbar bg-gray-100">
                                    {stallForm.products.map((prod, idx) => {
                                        const costDetail = getDetailedCost(prod.recipeId);
                                        const subtotal = (prod.soldQty || 0) * (prod.price || 0);
                                        const rowNet = subtotal - (prod.discount || 0);

                                        return (
                                        <div key={idx} className="flex flex-col bg-white p-3 rounded-lg border shadow-sm relative gap-3">
                                            <button 
                                                onClick={() => { const n = stallForm.products.filter((_, i) => i !== idx); setStallForm({ ...stallForm, products: n }) }} 
                                                className="absolute top-2 right-2 flex items-center bg-red-50 text-red-500 hover:bg-red-100 px-2 py-1 rounded text-xs font-bold border border-red-100 z-10"
                                            >
                                                <Trash2 size={14} className="mr-1"/> ç§»é™¤
                                            </button>

                                            <div className="flex justify-between items-center pr-16">
                                                <select className="flex-1 border p-1.5 rounded text-sm mr-2 font-bold text-gray-700" value={prod.recipeId} onChange={e => {
                                                    const n = [...stallForm.products];
                                                    const r = recipes.find(x => x.id === e.target.value);
                                                    n[idx] = { ...n[idx], recipeId: e.target.value, price: r ? r.sellingPrice : 0 };
                                                    setStallForm({ ...stallForm, products: n });
                                                }}>
                                                    {(recipes||[]).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                                </select>
                                                <select className="w-20 border p-1.5 rounded text-sm bg-gray-50" value={prod.unit} onChange={e => {
                                                    const n = [...stallForm.products];
                                                    n[idx].unit = e.target.value;
                                                    setStallForm({ ...stallForm, products: n });
                                                }}>
                                                    <option value="portion">ä»½/å€‹</option>
                                                    <option value="g">å…‹(g)</option>
                                                </select>
                                            </div>
                                            
                                            <div className="text-[10px] text-gray-500 bg-indigo-50 p-1.5 rounded flex justify-between px-2">
                                                <span>å–®ä»½æˆæœ¬: <b>${(costDetail.totalPerPortion || 0).toFixed(1)}</b></span>
                                                <span className="text-gray-400">(é£Ÿæ${(costDetail.ingCostPerPortion || 0).toFixed(1)} / åŒ…æ${(costDetail.pkgCostPerPortion || 0).toFixed(1)})</span>
                                            </div>

                                            <div className="grid grid-cols-4 gap-2 text-center">
                                                <div><label className="text-[10px] text-gray-400 block">å–®åƒ¹</label><input type="number" className="w-full border p-1 rounded text-sm text-center" value={prod.price} onChange={e => { const n = [...stallForm.products]; n[idx].price = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} /></div>
                                                <div><label className="text-[10px] text-gray-400 block">æº–å‚™é‡</label><input type="number" className="w-full border p-1 rounded text-sm text-center" value={prod.prepareQty} onChange={e => { const n = [...stallForm.products]; n[idx].prepareQty = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} /></div>
                                                <div><label className="text-[10px] text-gray-400 block font-bold text-green-600">å”®å‡º</label><input type="number" className="w-full border p-1 rounded text-sm text-center font-bold text-green-600 bg-green-50" value={prod.soldQty} onChange={e => { const n = [...stallForm.products]; n[idx].soldQty = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} /></div>
                                                <div className="flex gap-1">
                                                    <div><label className="text-[10px] text-gray-400 block">è€—æ</label><input type="number" className="w-full border p-1 rounded text-sm text-center text-red-500" value={prod.wasteQty || 0} onChange={e => { const n = [...stallForm.products]; n[idx].wasteQty = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} /></div>
                                                    <div><label className="text-[10px] text-gray-400 block">è©¦åƒ</label><input type="number" className="w-full border p-1 rounded text-sm text-center text-orange-500" value={prod.tastingQty || 0} onChange={e => { const n = [...stallForm.products]; n[idx].tastingQty = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} /></div>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-end space-x-2 mt-1 pt-2 border-t border-gray-100">
                                                <span className="text-xs text-gray-400">å°è¨ˆ ${subtotal}</span>
                                                <span className="text-xs text-gray-400">-</span>
                                                <div className="flex items-center bg-red-50 rounded px-1">
                                                    <span className="text-xs text-red-500 mr-1">æŠ˜åƒ¹</span>
                                                    <input type="number" className="w-16 text-xs p-1 border border-red-200 rounded text-right text-red-600 font-bold" placeholder="0" value={prod.discount} onChange={e => { const n = [...stallForm.products]; n[idx].discount = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, products: n }) }} />
                                                </div>
                                                <span className="text-xs text-gray-400">=</span>
                                                <span className="text-sm font-bold text-indigo-700">å¯¦æ”¶ ${Math.max(0, rowNet)}</span>
                                            </div>
                                        </div>
                                    )})}
                                </div>
                            </div>
                            
                            <div className="bg-white border rounded-xl overflow-hidden">
                                <div className="bg-yellow-50 p-3 border-b flex justify-between items-center">
                                    <h4 className="font-bold text-yellow-800 flex items-center"><Gift size={16} className="mr-2"/> ä¿ƒéŠ·/è´ˆå“ (æ‰£åº«å­˜/ç„¡ç‡Ÿæ”¶)</h4>
                                    <button onClick={addGift} className="text-xs bg-yellow-600 text-white px-3 py-1.5 rounded shadow">+ åŠ å…¥è´ˆå“</button>
                                </div>
                                <div className="p-2 space-y-2">
                                    {stallForm.gifts && stallForm.gifts.map((gift, idx) => (
                                        <div key={idx} className="flex flex-col p-2 border rounded bg-yellow-50/50 gap-2 relative">
                                            <button 
                                                onClick={() => { const n = stallForm.gifts.filter((_, i) => i !== idx); setStallForm({ ...stallForm, gifts: n }) }} 
                                                className="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1"
                                            >
                                                <X size={16} />
                                            </button>

                                            <div className="flex items-center pr-6">
                                                <select className="flex-1 text-xs p-1 bg-transparent border-none outline-none font-bold text-gray-700" value={gift.recipeId} onChange={e => {
                                                    const n = [...stallForm.gifts];
                                                    n[idx].recipeId = e.target.value;
                                                    setStallForm({ ...stallForm, gifts: n });
                                                }}>
                                                    {(recipes||[]).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                                </select>
                                                <input type="number" className="w-16 text-xs p-1 rounded border text-center" placeholder="æ•¸é‡" value={gift.qty} onChange={e => { const n = [...stallForm.gifts]; n[idx].qty = parseFloat(e.target.value) || 0; setStallForm({ ...stallForm, gifts: n }) }} />
                                            </div>
                                            
                                            <div className="flex items-center border-t border-yellow-200 pt-1">
                                                <span className="text-[10px] text-yellow-700 mr-2 whitespace-nowrap">å‚™è¨»:</span>
                                                <input type="text" className="flex-1 text-xs p-1 bg-white border border-yellow-200 rounded text-gray-600" placeholder="ä¾‹å¦‚: è²·ä¸€é€ä¸€..." value={gift.note || ''} onChange={e => { const n = [...stallForm.gifts]; n[idx].note = e.target.value; setStallForm({ ...stallForm, gifts: n }) }} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg text-sm">
                                <div>é ä¼°ç‡Ÿæ”¶: <span className="font-bold">${stats.revenue.toLocaleString()}</span></div>
                                <div className="text-right">
                                    <div className="font-bold text-red-500">ç¸½æˆæœ¬: ${Math.round(stats.totalCost).toLocaleString()}</div>
                                    <div className="text-[10px] text-gray-500">
                                        (é£Ÿæ${Math.round(stats.totalIngCost)} / åŒ…æ${Math.round(stats.totalPkgCost)} / æ”¤ä½é›œæ”¯${Math.round(stats.fixedFee)})
                                    </div>
                                </div>
                                <div>æ·¨åˆ©: <span className={`font-bold ${stats.netProfit > 0 ? 'text-green-600' : 'text-red-500'}`}>${stats.netProfit.toLocaleString()}</span></div>
                            </div>
                            
                            <div className="flex justify-end space-x-3 pt-4 border-t">
                                <button onClick={() => setEditingId(null)} className="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button>
                                <button onClick={save} className="px-4 py-2 bg-indigo-600 text-white rounded shadow">å„²å­˜æ´»å‹•</button>
                            </div>
                        </div>
                    </Modal>
                );
            }

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-gray-800">æ“ºæ”¤ç®¡ç†</h2><button onClick={startNew} className="bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center"><Plus size={18} className="mr-1" /> æ–°å¢æ“ºæ”¤</button></div>
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {safeStallsList.map(stall => {
                             const isCompleted = stall.status === 'completed';
                             const displayDate = stall.startDate === stall.endDate ? stall.startDate : `${stall.startDate} ~ ${stall.endDate}`;
                             const revenue = stall.totalRevenue || 0;
                             const cost = stall.totalCost || 0;
                             const netProfit = revenue - cost;
                             
                             return (
                                <Card key={stall.id} className="p-4 flex flex-col justify-between">
                                    <div className="mb-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <div><h3 className="font-bold text-lg">{stall.name}</h3><p className="text-xs text-gray-500 flex items-center"><MapPin size={10} className="mr-1"/>{stall.location}</p></div>
                                            <Badge color={isCompleted ? 'green' : 'yellow'}>{isCompleted ? 'å·²çµç®—' : 'é€²è¡Œä¸­'}</Badge>
                                        </div>
                                        <div className="text-sm text-gray-600 space-y-1">
                                            <div className="flex items-center text-xs"><Calendar size={12} className="mr-2"/> {displayDate}</div>
                                            <div className="flex items-center justify-between bg-gray-50 p-2 rounded"><span>ç¸½ç‡Ÿæ”¶</span><span className="font-bold text-indigo-600">${revenue.toLocaleString()}</span></div>
                                            <div className="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>ç‰©æ–™/æ”¤ä½è²»: ${Math.round(cost).toLocaleString()}</span>
                                                <span className={`${netProfit >= 0 ? 'text-green-600' : 'text-red-500'} font-bold`}>æ·¨åˆ©: ${netProfit.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        {!isCompleted && <button onClick={() => onDeductStock(stall)} className="w-full py-2 bg-green-50 text-green-600 border border-green-200 rounded font-bold hover:bg-green-100 flex justify-center items-center"><CheckCircle size={16} className="mr-1"/> çµç®—ä¸¦æ‰£åº«å­˜</button>}
                                        <div className="flex space-x-2">
                                            <button onClick={() => startEdit(stall)} className="flex-1 py-1.5 bg-gray-100 text-gray-600 rounded text-sm hover:bg-gray-200">ç·¨è¼¯è©³ç´°</button>
                                            <button onClick={() => onDelete(stall.id)} className="px-3 bg-red-50 text-red-500 rounded border border-red-100 flex items-center justify-center"><Trash2 size={16} color="#ef4444" className="mr-1"/><span className="text-xs font-bold">åˆªé™¤</span></button>
                                        </div>
                                    </div>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- InventoryTable (V139 - Clear All Button Added) ---
        const InventoryTable = ({ type, data, onSave, onDelete, onClearAll }) => {
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', unit: 'g', packPrice: 0, packSize: 0, packCount: 0, yieldRate: 100, cost: 0, stock: 0, lowStockThreshold: 0, supplier: '', purchaseDate: '', nutrition: {} });
            const isIngredient = type === 'ingredients';
            const title = isIngredient ? 'é£Ÿæåº«å­˜' : 'åŒ…æåº«å­˜';
            const fileInputRef = useRef(null);

            const startEdit = (item) => { 
                setEditingId(item.id); 
                const packSize = item.packSize || 0; 
                const defaultNutrition = NUTRIENTS.reduce((acc, curr) => ({...acc, [curr.key]: 0}), {});
                let displayYield = item.yieldRate;
                if (displayYield <= 1 && displayYield > 0) displayYield = displayYield * 100;
                setEditForm({ ...item, packPrice: item.packPrice !== undefined ? item.packPrice : (item.cost || 0), packSize: item.packSize !== undefined ? item.packSize : 0, packCount: item.packCount !== undefined ? item.packCount : (item.packSize > 0 ? (item.stock / item.packSize) : 0), yieldRate: displayYield, nutrition: item.nutrition || defaultNutrition, lowStockThreshold: item.lowStockThreshold || 0, purchaseDate: item.purchaseDate || '', supplier: item.supplier || '', unit: item.unit || 'g' }); 
            };
            const startNew = () => { setEditingId('new'); setEditForm({ name: '', unit: 'g', packPrice: 0, packSize: 0, packCount: 0, yieldRate: 100, cost: 0, stock: 0, lowStockThreshold: 0, supplier: '', purchaseDate: new Date().toISOString().split('T')[0], nutrition: NUTRIENTS.reduce((acc, curr) => ({...acc, [curr.key]: 0}), {}) }); };
            const handlePurchaseChange = (field, value) => { const newForm = { ...editForm, [field]: value }; const pPrice = parseFloat(newForm.packPrice) || 0; const pSize = parseFloat(newForm.packSize) || 0; const pCount = parseFloat(newForm.packCount) || 0; let pYield = parseFloat(newForm.yieldRate); if (pSize > 0) { const yieldFactor = (pYield || 100) / 100; newForm.cost = pPrice / (pSize * yieldFactor); } if (!newForm.parentIngredientId) { newForm.stock = pSize * pCount; } setEditForm(newForm); };
            const handleImportClick = () => fileInputRef.current.click();
            const handleFileUpload = async (e) => { const file = e.target.files[0]; if (!file) return; try { if (!window.XLSX) await loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"); const reader = new FileReader(); reader.onload = (evt) => { const data = new Uint8Array(evt.target.result); const workbook = window.XLSX.read(data, { type: 'array' }); const jsonData = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); processExcelData(jsonData); }; reader.readAsArrayBuffer(file); } catch (error) { console.error(error); alert("åŒ¯å…¥å¤±æ•—"); } e.target.value = ''; };
            const processExcelData = (rows) => { let count = 0; const findKey = (row, keywords) => { const keys = Object.keys(row); for (const kw of keywords) { if (row[kw] !== undefined) return row[kw]; const foundKey = keys.find(k => k.includes(kw)); if (foundKey) return row[foundKey]; } return undefined; }; rows.forEach(row => { const name = findKey(row, ['åç¨±', 'å“é …']); if (!name) return; const packPrice = parseFloat(findKey(row, ['é€²åƒ¹', 'åƒ¹æ ¼']) || 0); const packSize = parseFloat(findKey(row, ['é‡é‡', 'è¦æ ¼']) || 0); let unit = findKey(row, ['å–®ä½']) || 'g'; if(unit === 'å€‹') unit = 'pc'; const supplier = findKey(row, ['ä¾›æ‡‰å•†', 'å» å•†']) || ''; const lowStockThreshold = parseFloat(findKey(row, ['å®‰å…¨æ°´ä½', 'è­¦ç¤º', 'ä½åº«å­˜']) || 0); let yieldRate = 100; if (row['å¾—ç‡(%)'] !== undefined) yieldRate = row['å¾—ç‡(%)']; else if (row['å¾—ç‡%'] !== undefined) yieldRate = row['å¾—ç‡%']; else { const cleanKey = Object.keys(row).find(k => k.includes('å¾—ç‡') && !k.match(/[åƒ¹é¡éŒ¢]/)); if (cleanKey) yieldRate = row[cleanKey]; } if (yieldRate <= 1 && yieldRate > 0) { yieldRate = yieldRate * 100; } yieldRate = parseFloat(yieldRate) || 100; const yieldFactor = yieldRate / 100; let cost = 0; if (packSize > 0) cost = packPrice / (packSize * yieldFactor); const nutrition = {}; NUTRIENTS.forEach(n => { nutrition[n.key] = parseFloat(findKey(row, [n.label]) || 0); }); const newItem = { id: generateUniqueId(), name, packPrice, packSize, unit, yieldRate, cost, stock: 0, lowStockThreshold, supplier, purchaseDate: new Date().toISOString().split('T')[0], nutrition }; onSave(newItem); count++; }); alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™ï¼`); };
            const save = () => { if (!editForm.name) return alert('è«‹è¼¸å…¥åç¨±'); onSave(editForm, editingId === 'new' ? null : editingId); setEditingId(null); };
            const closeModal = () => { setEditingId(null); setEditForm({}); };

            const confirmClearAll = () => {
                if (confirm(`ç¢ºå®šè¦ã€æ¸…ç©ºã€‘æ‰€æœ‰${title}è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                    onClearAll();
                }
            };

            if (editingId) {
                const potentialParents = data.filter(i => i.id !== editingId && !i.parentIngredientId);
                const rawUnitPrice = editForm.packSize > 0 ? (editForm.packPrice / editForm.packSize) : 0;
                const realCost = typeof editForm.cost === 'number' ? editForm.cost : 0;
                return (<Modal title={`${editingId === 'new' ? 'æ–°å¢' : 'ç·¨è¼¯'} ${isIngredient ? 'é£Ÿæ' : 'åŒ…æ'}`} onClose={closeModal}><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="space-y-4"><h4 className="font-bold text-indigo-600 border-b pb-2">åŸºæœ¬è³‡æ–™</h4><div><label className="block text-xs font-bold text-gray-500 uppercase">å“å</label><input className="w-full p-2 border rounded" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} placeholder="ä¾‹å¦‚: éºµç²‰" /></div>{isIngredient && (<div className="bg-indigo-50 p-3 rounded border border-indigo-100"><label className="block text-xs font-bold text-indigo-700 mb-1 flex items-center"><Link size={14} className="mr-1"/> é€£çµå¯¦éš›åº«å­˜</label><select className="w-full p-2 border rounded text-sm" value={editForm.parentIngredientId || ''} onChange={e => setEditForm({...editForm, parentIngredientId: e.target.value, stock: 0})}><option value="">ç„¡ (ç¨ç«‹åº«å­˜)</option>{potentialParents.map(p => <option key={p.id} value={p.id}>é€£çµè‡³: {p.name} (åº«å­˜: {p.stock}{p.unit})</option>)}</select></div>)}<div className="bg-gray-50 p-4 rounded-lg space-y-3 border border-gray-200"><h5 className="font-bold text-sm text-gray-700">æ¡è³¼è³‡è¨Š / æˆæœ¬è¨­å®š</h5><div className="flex space-x-2"><div className="flex-1"><label className="text-xs text-gray-500">ä¸€åŒ…åƒ¹æ ¼($)</label><SafeNumberInput className="w-full p-2 border rounded bg-white" value={editForm.packPrice} onChange={v => handlePurchaseChange('packPrice', v)} /></div><div className="flex-1"><label className="text-xs text-gray-500">é‡é‡/è¦æ ¼</label><SafeNumberInput className="w-full p-2 border rounded bg-white" value={editForm.packSize} onChange={v => handlePurchaseChange('packSize', v)} /></div><div className="w-24"><label className="text-xs text-gray-500">å–®ä½</label><select className="w-full p-2 border rounded bg-white h-[42px]" value={editForm.unit} onChange={e=>setEditForm({...editForm, unit: e.target.value})}><option value="g">g</option><option value="ml">ml</option><option value="pc">å€‹</option></select></div></div>{isIngredient && (<div className="flex items-center space-x-2"><div className="flex-1"><label className="text-xs text-gray-500">å¾—ç‡ (%)</label><SafeNumberInput className="w-full p-2 border rounded bg-white" value={editForm.yieldRate} onChange={v => handlePurchaseChange('yieldRate', v)} placeholder="100" /></div><div className="flex-1 pt-4 text-xs text-gray-400">å¯¦éš›å¯ç”¨: {Math.round((parseFloat(editForm.packSize)||0) * ((parseFloat(editForm.yieldRate)||100)/100 || 1))}{editForm.unit}</div></div>)}{!editForm.parentIngredientId && (<div><label className="text-xs text-gray-500">è³¼è²·åŒ…æ•¸ (åŠ ç¸½åº«å­˜)</label><SafeNumberInput className="w-full p-2 border rounded bg-white" value={editForm.packCount} onChange={v => handlePurchaseChange('packCount', v)} /></div>)}<div className="bg-white p-3 border border-indigo-100 rounded text-sm"><div className="flex justify-between text-gray-500 text-xs mb-1"><span>åŸå§‹å–®åƒ¹:</span><span>${rawUnitPrice.toFixed(4)} / {editForm.unit}</span></div><div className="flex justify-between font-bold text-indigo-700 border-t pt-1 mt-1"><span className="flex items-center"><Info size={12} className="mr-1"/>çœŸå¯¦å–®åƒ¹ (å«æè€—):</span><span>${realCost < 0.0001 && realCost > 0 ? '< 0.0001' : realCost.toFixed(4)} / {editForm.unit}</span></div></div></div><div className="grid grid-cols-2 gap-2 bg-red-50 p-2 rounded border border-red-100"><div><label className="text-xs text-red-700 font-bold">å®‰å…¨æ°´ä½</label><SafeNumberInput className="w-full p-2 border rounded bg-white" value={editForm.lowStockThreshold} onChange={v => setEditForm({...editForm, lowStockThreshold: parseFloat(v) || 0})} placeholder="è­¦ç¤ºå€¼" /></div><div className="flex items-end pb-2 text-xs text-red-500 font-bold">å–®ä½: {editForm.unit}</div></div><div className="grid grid-cols-2 gap-2"><div><label className="text-xs text-gray-500">ä¾›æ‡‰å•†</label><input className="w-full p-2 border rounded" value={editForm.supplier} onChange={e => setEditForm({...editForm, supplier: e.target.value})} /></div><div><label className="text-xs text-gray-500">è³¼å…¥æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded" value={editForm.purchaseDate} onChange={e => setEditForm({...editForm, purchaseDate: e.target.value})} /></div></div></div>{isIngredient && (<div className="space-y-4"><h4 className="font-bold text-green-600 border-b pb-2 flex items-center"><FileText size={18} className="mr-2"/> ç‡Ÿé¤Šæ¨™ç¤º (æ¯ 100g)</h4><div className="grid grid-cols-2 gap-3 bg-green-50 p-4 rounded-lg border border-green-100">{NUTRIENTS.map(nut => (<div key={nut.key}><label className="text-xs text-gray-500">{nut.label} ({nut.unit})</label><SafeNumberInput className="w-full p-2 border rounded bg-white focus:ring-1 focus:ring-green-500" value={editForm.nutrition?.[nut.key] || 0} onChange={v => setEditForm({...editForm, nutrition: { ...editForm.nutrition, [nut.key]: parseFloat(v) || 0 }})} /></div>))}</div></div>)}</div><div className="flex justify-end space-x-3 mt-8 pt-4 border-t"><button onClick={closeModal} className="px-6 py-2 bg-gray-200 rounded-lg font-bold text-gray-600">å–æ¶ˆ</button><button onClick={save} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-lg hover:bg-indigo-700">å„²å­˜è³‡æ–™</button></div></Modal>);
            }
            return (
                <div className="space-y-4">
                    <div className="flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
                        <h2 className="text-2xl font-bold text-gray-800">{title}</h2>
                        <div className="flex space-x-2">
                             <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx, .xls" className="hidden" />
                             <button onClick={handleImportClick} className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center shadow hover:bg-green-700"><Upload size={18} className="mr-1" /> åŒ¯å…¥ Excel</button>
                             {/* ğŸ”¥ V139: æ¸…ç©ºæŒ‰éˆ• */}
                             {data.length > 0 && <button onClick={confirmClearAll} className="bg-red-500 text-white px-3 py-2 rounded-lg flex items-center shadow hover:bg-red-600 text-sm"><Trash2 size={16} className="mr-1"/> æ¸…ç©º</button>}
                             <button onClick={startNew} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-indigo-700"><Plus size={18} className="mr-1" /> æ–°å¢</button>
                        </div>
                    </div>
                    <div className="grid gap-3 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">{(data||[]).map(item => { const parent = item.parentIngredientId ? data.find(d => d.id === item.parentIngredientId) : null; const isLow = !parent && item.stock < (item.lowStockThreshold || (item.unit==='g'?500:10)); return (<div key={item.id} className={`bg-white p-4 rounded-xl border shadow-sm flex flex-col justify-between group hover:border-indigo-300 transition-colors ${isLow ? 'border-red-300 ring-1 ring-red-200' : 'border-gray-100'}`}><div><div className="flex justify-between items-start mb-2"><h4 className="font-bold text-lg text-gray-800">{item.name}</h4>{parent ? (<Badge color="blue">é€£: {parent.name}</Badge>) : (<Badge color={isLow ? 'red' : 'gray'}>{item.stock} {item.unit}</Badge>)}</div><div className="text-sm text-gray-500 mb-2"><div className="flex items-center"><MapPin size={12} className="mr-1"/> {item.supplier || 'æœªè¨­å®š'}</div><div className="flex items-center"><Calendar size={12} className="mr-1"/> {item.purchaseDate || '--'}</div></div>{item.packPrice !== undefined && (<div className="text-xs bg-gray-50 p-2 rounded text-gray-600 mb-2">çœŸå¯¦å–®åƒ¹: ${typeof item.cost === 'number' ? item.cost.toFixed(4) : 0} / {item.unit} {item.yieldRate < 100 && <span className="text-orange-500 ml-1">(å¾—ç‡{item.yieldRate}%)</span>}</div>)}{isLow && <div className="text-xs text-red-500 font-bold flex items-center mb-1"><AlertTriangle size={12} className="mr-1"/> ä½æ–¼æ°´ä½ {item.lowStockThreshold}{item.unit}</div>}</div><div className="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-50"><button onClick={() => startEdit(item)} className="px-3 py-1.5 text-indigo-600 bg-indigo-50 rounded text-sm font-medium flex items-center"><Edit3 size={14} className="mr-1"/> ç·¨è¼¯</button><button onClick={() => onDelete(item.id)} className="px-3 py-1.5 text-red-500 bg-red-50 rounded text-sm font-medium flex items-center border border-red-200 hover:bg-red-100"><Trash2 size={16} className="mr-1"/> åˆªé™¤</button></div></div>); })}</div>
                </div>
            );
        };

        // --- App (V146 - Zombie Data Killer) ---
        // 1. å¼·åˆ¶ ID ä¿®å¾©ï¼šç¢ºä¿æ¯ä¸€ç­†è³‡æ–™éƒ½æœ‰ç¨ä¸€ç„¡äºŒçš„ IDï¼Œè§£æ±ºã€Œåˆªä¸€å€‹æ­»å…¨éƒ¨ã€çš„å•é¡Œã€‚
        // 2. åŒæ­¥é‚è¼¯å„ªåŒ–ï¼šç¢ºä¿é›²ç«¯èˆ‡æœ¬åœ°è³‡æ–™ä¸€è‡´ã€‚
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [recipes, setRecipes] = useStickyState([], 'baking_recipes_v3');
            const [ingredients, setIngredients] = useStickyState([], 'baking_ingredients_v3');
            const [packaging, setPackaging] = useStickyState([], 'baking_packaging_v3');
            const [orders, setOrders] = useStickyState([], 'baking_orders_v3');
            const [stalls, setStalls] = useStickyState([], 'baking_stalls_v3');
            const [firebaseStatus, setFirebaseStatus] = useState('disconnected');

            // ğŸ”¥ V146: å¼·åŠ› ID ä¿®å¾©èˆ‡å»é‡ (ç•¶è³‡æ–™è¼‰å…¥æ™‚åŸ·è¡Œ)
            useEffect(() => {
                const repairAndDedupe = (data, setter, name) => {
                    if (!Array.isArray(data)) return;
                    let hasChanges = false;
                    const seenIds = new Set();
                    
                    const fixedData = data.map(item => {
                        // 1. å¦‚æœæ²’æœ‰ IDï¼Œé…ç™¼ä¸€å€‹
                        // 2. å¦‚æœ ID é‡è¤‡ï¼Œé…ç™¼æ–°çš„
                        let currentId = item.id;
                        if (!currentId || seenIds.has(currentId)) {
                            hasChanges = true;
                            currentId = `fixed_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
                        }
                        seenIds.add(currentId);
                        return { ...item, id: currentId };
                    });

                    if (hasChanges) {
                        console.log(`æ­£åœ¨ä¿®å¾© ${name} çš„ ID å•é¡Œ...`);
                        setter(fixedData);
                    }
                };

                repairAndDedupe(recipes, setRecipes, 'recipes');
                repairAndDedupe(ingredients, setIngredients, 'ingredients');
                repairAndDedupe(packaging, setPackaging, 'packaging');
                repairAndDedupe(orders, setOrders, 'orders');
                repairAndDedupe(stalls, setStalls, 'stalls');
            }, [recipes, ingredients, packaging, orders, stalls]);

            useEffect(() => {
                const savedConfig = localStorage.getItem('baking_firebase_config');
                if (savedConfig && window.firebase) {
                    try {
                        const config = JSON.parse(savedConfig);
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        setFirebaseStatus('connected');
                        
                        const db = firebase.firestore();
                        const collections = [
                            { name: 'recipes', setter: setRecipes },
                            { name: 'ingredients', setter: setIngredients },
                            { name: 'packaging', setter: setPackaging },
                            { name: 'orders', setter: setOrders },
                            { name: 'stalls', setter: setStalls }
                        ];

                        const unsubscribes = [];
                        
                        collections.forEach(({ name, setter }) => {
                            const unsub = db.collection(name).onSnapshot(snapshot => {
                                // V146: åªè¦é›²ç«¯æœ‰è®Šå‹•ï¼Œå°±åŒæ­¥ä¸‹ä¾† (é™¤éé›²ç«¯è¢«æ„å¤–æ¸…ç©º)
                                if (!snapshot.empty) {
                                    const remoteData = snapshot.docs.map(doc => doc.data());
                                    // ç°¡å–®æ¯”å°é•·åº¦ï¼Œé¿å…ç„¡é™è¿´åœˆ
                                    setter(remoteData);
                                }
                            }, error => {
                                console.error(`åŒæ­¥ ${name} å¤±æ•—:`, error);
                            });
                            unsubscribes.push(unsub);
                        });

                        return () => {
                            unsubscribes.forEach(func => func());
                        };

                    } catch (e) { console.error("Firebase Init Error", e); }
                }
            }, []);

            const onConnectFirebase = (config) => { localStorage.setItem('baking_firebase_config', JSON.stringify(config)); window.location.reload(); };
            const onDisconnectFirebase = () => { localStorage.removeItem('baking_firebase_config'); window.location.reload(); };
            
            const handleSave = async (col, data, id) => { 
                const map = { 'recipes': setRecipes, 'ingredients': setIngredients, 'packaging': setPackaging, 'orders': setOrders, 'stalls': setStalls }; 
                const setter = map[col]; 
                // ç¢ºä¿ ID å­˜åœ¨
                const newId = id || `doc_${Date.now()}_${Math.random().toString(36).substr(2,5)}`; 
                const finalData = { ...data, id: newId };

                setter(prev => { 
                    const safePrev = Array.isArray(prev) ? prev : [];
                    if (id) return safePrev.map(item => item.id === id ? finalData : item); 
                    return [...safePrev, finalData]; 
                }); 
                
                if (firebaseStatus === 'connected') { 
                    try { await firebase.firestore().collection(col).doc(newId).set(finalData, { merge: true }); } 
                    catch(e) { alert("é›²ç«¯å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼"); }
                } 
            };
            
            const handleDelete = async (col, id) => { 
                if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return; 
                const map = { 'recipes': setRecipes, 'ingredients': setIngredients, 'packaging': setPackaging, 'orders': setOrders, 'stalls': setStalls }; 
                
                // 1. æœ¬åœ°åˆªé™¤
                map[col](prev => (Array.isArray(prev) ? prev : []).filter(i => String(i.id) !== String(id))); 
                
                // 2. é›²ç«¯åˆªé™¤
                if (firebaseStatus === 'connected') {
                    try { await firebase.firestore().collection(col).doc(id).delete(); } 
                    catch (e) { console.error("é›²ç«¯åˆªé™¤å¤±æ•—", e); }
                }
            };

            const handleClearAll = async (col) => {
                const map = { 'recipes': setRecipes, 'ingredients': setIngredients, 'packaging': setPackaging, 'orders': setOrders, 'stalls': setStalls }; 
                map[col]([]);
                if (firebaseStatus === 'connected') {
                    const db = firebase.firestore();
                    const batch = db.batch();
                    const snapshot = await db.collection(col).get();
                    snapshot.docs.forEach((doc) => { batch.delete(doc.ref); });
                    try { await batch.commit(); alert("é›²ç«¯è³‡æ–™ä¹Ÿå·²æ¸…ç©ºï¼"); } 
                    catch(e) { console.error(e); alert("æœ¬åœ°å·²æ¸…ç©ºï¼Œä½†é›²ç«¯åˆªé™¤éƒ¨åˆ†å¤±æ•—ã€‚"); }
                }
            };
            
            const handleCompleteOrder = (order, newStatus) => { 
                if (!confirm(`ç¢ºå®šè¦å°‡è¨‚å–®è¨­ç‚º ${newStatus} ä¸¦æ‰£é™¤ç›¸æ‡‰åº«å­˜å—ï¼Ÿ`)) return; 
                let errors = []; const newIng = [...ingredients]; const newPkg = [...packaging]; 
                order.items.forEach(item => { 
                    const r = recipes.find(rec => rec.id === item.recipeId); 
                    if (!r) { errors.push(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å•†å“ã€Œ${item.recipeName}ã€çš„é£Ÿè­œã€‚`); return; } 
                    if(r.items) { r.items.forEach(ri => { let targetId = ri.id; const originalIng = newIng.find(i => i.id === ri.id); if (originalIng && originalIng.parentIngredientId) targetId = originalIng.parentIngredientId; const ingIdx = newIng.findIndex(i => i.id === targetId); if(ingIdx > -1) { const deduct = (ri.qty / (r.yieldCount||1)) * item.qty; newIng[ingIdx] = {...newIng[ingIdx], stock: newIng[ingIdx].stock - deduct}; } else { errors.push(`è­¦å‘Šï¼šæ‰¾ä¸åˆ°é£Ÿæ ID:${targetId}`); } }); } 
                    if(r.packagingItems) { r.packagingItems.forEach(pi => { const pkgIdx = newPkg.findIndex(p => p.id === pi.id); if(pkgIdx > -1) { newPkg[pkgIdx] = {...newPkg[pkgIdx], stock: newPkg[pkgIdx].stock - (pi.qty * item.qty)}; } else { errors.push(`è­¦å‘Šï¼šæ‰¾ä¸åˆ°åŒ…æ ID:${pi.id}`); } }) } 
                }); 
                if (errors.length > 0) alert(errors.join('\n')); 
                setIngredients(newIng); setPackaging(newPkg); 
                handleSave('orders', {...order, status: newStatus}, order.id);
                newIng.forEach(i => handleSave('ingredients', i, i.id));
                newPkg.forEach(p => handleSave('packaging', p, p.id));
                alert('è¨‚å–®å·²å®Œæˆä¸¦æ‰£é™¤åº«å­˜ï¼'); 
            };

            const handleStallStockDeduct = (stall) => { 
                if (!confirm('ç¢ºå®šè¦ä¾ç…§è£½ä½œé‡èˆ‡è´ˆå“æ‰£é™¤åº«å­˜å—ï¼Ÿ')) return; 
                const newIng = [...ingredients]; const newPkg = [...packaging]; 
                (stall.products || []).forEach(prod => { 
                    const r = recipes.find(rec => rec.id === prod.recipeId); 
                    if(r) { 
                        const totalDeductQty = (prod.soldQty || 0) + (prod.wasteQty || 0) + (prod.tastingQty || 0);
                        if(totalDeductQty > 0) {
                            const recipeDetails = (() => {
                                let totalWeight = 0;
                                (r.items||[]).forEach(i => {
                                    const ing = ingredients.find(ing => ing.id === i.id) || ingredients.find(ing => ing.name === i.name);
                                    if(ing && (ing.unit === 'g' || ing.unit === 'ml')) totalWeight += i.qty;
                                });
                                return { totalWeight, yieldCount: r.yieldCount || 1 };
                            })();
                            let deductRatio = 0;
                            if (prod.unit === 'g') { deductRatio = totalDeductQty / (recipeDetails.totalWeight || 1); } 
                            else { deductRatio = totalDeductQty / (recipeDetails.yieldCount || 1); }
                            r.items.forEach(ri => { 
                                let targetId = ri.id; 
                                const originalIng = newIng.find(i => i.id === ri.id); 
                                if (originalIng && originalIng.parentIngredientId) targetId = originalIng.parentIngredientId; 
                                const ingIdx = newIng.findIndex(i => i.id === targetId); 
                                if(ingIdx > -1) { const deduct = ri.qty * deductRatio; newIng[ingIdx] = {...newIng[ingIdx], stock: newIng[ingIdx].stock - deduct}; } 
                            }); 
                             if (prod.unit !== 'g') {
                                (r.packagingItems || []).forEach(pi => { 
                                    const pkgIdx = newPkg.findIndex(p => p.id === pi.id); 
                                    if(pkgIdx > -1) { newPkg[pkgIdx] = {...newPkg[pkgIdx], stock: newPkg[pkgIdx].stock - (pi.qty * totalDeductQty)}; } 
                                }); 
                            }
                        }
                    } 
                }); 
                (stall.gifts || []).forEach(gift => {
                    const r = recipes.find(rec => rec.id === gift.recipeId);
                    if(r && gift.qty > 0) {
                         r.items.forEach(ri => { 
                            let targetId = ri.id; 
                            const originalIng = newIng.find(i => i.id === ri.id); 
                            if (originalIng && originalIng.parentIngredientId) targetId = originalIng.parentIngredientId; 
                            const ingIdx = newIng.findIndex(i => i.id === targetId); 
                            if(ingIdx > -1) { const amountPerUnit = ri.qty / (r.yieldCount || 1); const deduct = amountPerUnit * gift.qty; newIng[ingIdx] = {...newIng[ingIdx], stock: newIng[ingIdx].stock - deduct}; } 
                        }); 
                        (r.packagingItems || []).forEach(pi => { 
                            const pkgIdx = newPkg.findIndex(p => p.id === pi.id); 
                            if(pkgIdx > -1) { newPkg[pkgIdx] = {...newPkg[pkgIdx], stock: newPkg[pkgIdx].stock - (pi.qty * gift.qty)}; } 
                        }); 
                    }
                });
                setIngredients(newIng); setPackaging(newPkg); 
                handleSave('stalls', {...stall, status: 'completed'}, stall.id);
                newIng.forEach(i => handleSave('ingredients', i, i.id));
                newPkg.forEach(p => handleSave('packaging', p, p.id));
                alert('æ“ºæ”¤åº«å­˜ (å«è€—æã€è©¦åƒã€è´ˆå“) å·²æ‰£é™¤ï¼'); 
            };

            const navItems = [ { id: 'dashboard', label: 'å„€è¡¨æ¿', icon: LayoutDashboard }, { id: 'report', label: 'éŠ·å”®å ±è¡¨', icon: BarChart2 }, { id: 'orders', label: 'è¨‚å–®ç®¡ç†', icon: ClipboardList }, { id: 'stalls', label: 'æ“ºæ”¤ç®¡ç†', icon: Tent }, { id: 'recipes', label: 'é£Ÿè­œç®¡ç†', icon: ChefHat }, { id: 'ingredients', label: 'é£Ÿæåº«å­˜', icon: Utensils }, { id: 'packaging', label: 'åŒ…æç®¡ç†', icon: Package }, { id: 'settings', label: 'ç³»çµ±è¨­å®š', icon: Settings }, ];
            const handleNavClick = (id) => { setActiveTab(id); setIsMobileMenuOpen(false); };

            return (
                <div className="flex h-screen bg-gray-50 font-sans text-gray-900 overflow-hidden">
                    {isMobileMenuOpen && (
                        <div 
                            className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setIsMobileMenuOpen(false)}
                        ></div>
                    )}

                    <aside className={`
                        fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 ease-out sidebar-transition shadow-2xl
                        ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}
                        md:relative md:translate-x-0 md:flex flex-col md:shadow-none md:z-0
                    `}>
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center"><h1 className="text-xl font-bold text-indigo-600 flex items-center"><ChefHat className="mr-2"/> çƒ˜ç„™å¤§å¸« Pro</h1><button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-gray-500 hover:text-gray-800"><X size={24}/></button></div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">{navItems.map(item => (<button key={item.id} onClick={() => handleNavClick(item.id)} className={`w-full flex items-center p-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-50 text-indigo-700 font-medium' : 'text-gray-500 hover:bg-gray-50'}`}><item.icon className="mr-3" size={20}/>{item.label}</button>))}</nav>
                    </aside>
                    
                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        {/* æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°è¦½åˆ— */}
                        <div className="md:hidden bg-white p-4 shadow-sm border-b flex justify-between items-center z-10 sticky top-0">
                            <h1 className="font-bold text-lg text-indigo-600 flex items-center"><ChefHat size={20} className="mr-2"/> çƒ˜ç„™å¤§å¸« Pro</h1>
                            <button 
                                onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} 
                                className="flex items-center px-3 py-2 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-100 shadow-sm active:bg-indigo-100 transition-colors"
                            >
                                <Menu size={20} strokeWidth={2.5} className="mr-1.5" />
                                <span className="text-sm font-bold">é¸å–®</span>
                            </button>
                        </div>

                        <div className="flex-1 overflow-auto p-4 md:p-8">
                            {activeTab === 'dashboard' && <Dashboard recipes={recipes} ingredients={ingredients} packaging={packaging} orders={orders} stalls={stalls} />}
                            {activeTab === 'report' && <ReportManager recipes={recipes} orders={orders} stalls={stalls} />}
                            {activeTab === 'orders' && <OrderManager orders={orders} recipes={recipes} ingredients={ingredients} packaging={packaging} onSave={(d, id) => handleSave('orders', d, id)} onDelete={(id) => handleDelete('orders', id)} onUpdateStatus={handleCompleteOrder} />}
                            {activeTab === 'stalls' && <StallManager stalls={stalls} recipes={recipes} ingredients={ingredients} packaging={packaging} onSave={(d, id) => handleSave('stalls', d, id)} onDelete={(id) => handleDelete('stalls', id)} onDeductStock={handleStallStockDeduct} />}
                            {activeTab === 'recipes' && <RecipeManager recipes={recipes} ingredients={ingredients} packaging={packaging} onSave={(d, id) => handleSave('recipes', d, id)} onDelete={(id) => handleDelete('recipes', id)} onClearAll={() => handleClearAll('recipes')} />}
                            {activeTab === 'ingredients' && <InventoryTable type="ingredients" data={ingredients} onSave={(d, id) => handleSave('ingredients', d, id)} onDelete={(id) => handleDelete('ingredients', id)} onClearAll={() => handleClearAll('ingredients')} />}
                            {activeTab === 'packaging' && <InventoryTable type="packaging" data={packaging} onSave={(d, id) => handleSave('packaging', d, id)} onDelete={(id) => handleDelete('packaging', id)} onClearAll={() => handleClearAll('packaging')} />}
                            {activeTab === 'settings' && <DataManager firebaseStatus={firebaseStatus} onConnectFirebase={onConnectFirebase} onDisconnectFirebase={onDisconnectFirebase} recipes={recipes} ingredients={ingredients} packaging={packaging} setRecipes={setRecipes} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
